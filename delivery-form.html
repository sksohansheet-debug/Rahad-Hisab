<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delivery Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ✅ direct PDF downloader (no print dialog) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;

      --brand:#2563eb;
      --brand2:#60a5fa;
      --good:#16a34a;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 2px 10px rgba(15,23,42,.08);

      --r12:12px;
      --r16:16px;
      --r18:18px;

      --topbar-h: 64px;

      /* sticky header row heights */
      --del-head-row1: 28px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(16,185,129,.06), transparent 55%),
        var(--bg);
      color: var(--text);
      padding-top: var(--topbar-h);
    }

    .topbar{
      position: fixed;
      top:0; left:0; right:0;
      height: var(--topbar-h);
      z-index: 10;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229,231,235,.9);
      box-shadow: 0 8px 30px rgba(15,23,42,.06);
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
    }

    .title-box{
      flex:1;
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 2px;
      text-align: center;
    }
    .title{
      font-weight: 1000;
      font-size: 13px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sub{
      font-weight: 900;
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .date-box{
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 6px 8px;
      background:#fff;
      border:1px solid rgba(229,231,235,.9);
      border-radius: 12px;
      box-shadow: var(--shadow2);
    }
    .date-box label{
      font-size: 10px;
      font-weight: 1000;
      color: var(--muted);
    }
    .date-box input{
      width: 140px;
      border:1px solid rgba(229,231,235,.9);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 11px;
      font-weight: 900;
      outline:none;
    }
    .date-box input:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 3px rgba(37,99,235,.10);
    }

    .btn{
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 1000;
      font-size: 11px;
      padding: 8px 10px;
      display:flex;
      align-items:center;
      gap: 6px;
      box-shadow: var(--shadow2);
      white-space: nowrap;
      user-select: none;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.65; cursor:not-allowed; transform:none; }

    .btn-save{ background: linear-gradient(135deg, rgba(37,99,235,1), rgba(96,165,250,1)); color:#fff; }
    .btn-pdf{ background: linear-gradient(135deg, rgba(22,163,74,1), rgba(34,197,94,1)); color:#fff; }
    .btn-back{ background: linear-gradient(135deg, rgba(239,68,68,1), rgba(244,63,94,1)); color:#fff; }

    .wrap{
      padding: 10px 10px 18px 10px;
      width: 100%;
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 10px;
    }

    /* ✅ header inside page + in PDF */
    .print-header{
      text-align:center;
      font-weight: 1000;
      font-size: 12px;
      padding: 6px 6px 10px 6px;
      color:#0f172a;
    }
    .print-header small{
      display:block;
      font-weight: 900;
      font-size: 10px;
      color: rgba(15,23,42,.62);
      margin-top: 2px;
    }

    /* ✅ Full page table */
    .delivery-table-wrap{
      width: 100%;
      overflow: hidden;
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.9);
    }

    .delivery-table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 9.2px;
      white-space: nowrap;
    }
    .delivery-table th, .delivery-table td{
      border: 1px solid rgba(229,231,235,.95);
      padding: 3px 3px;
      text-align: center;
      vertical-align: middle;
      font-weight: 900;
      line-height: 1.02;
    }

    /* ✅ sticky 2-row header */
    .delivery-table thead th{
      background: #ffffff !important;
      color:#0f172a !important;
      position: sticky;
      z-index: 50;
      font-size: 9.2px;
      font-weight: 1000;
      padding: 5px 3px;
      box-shadow: 0 2px 0 rgba(15,23,42,.08);
      background-clip: padding-box;
    }
    .delivery-table thead tr:first-child th{
      top: 0;
      z-index: 60;
      height: var(--del-head-row1);
    }
    .delivery-table thead tr:nth-child(2) th{
      top: var(--del-head-row1);
      background: #f8fafc !important;
      z-index: 55;
      letter-spacing:.2px;
    }

    /* ✅ Column coloring */
    .delivery-table thead th:nth-child(2),
    .delivery-table thead th:nth-child(3),
    .delivery-table tbody td:nth-child(2),
    .delivery-table tbody td:nth-child(3),
    .delivery-table tfoot td:nth-child(2),
    .delivery-table tfoot td:nth-child(3){
      background: rgba(59,130,246,.07);
    }
    .delivery-table thead th:nth-child(4),
    .delivery-table thead th:nth-child(5),
    .delivery-table tbody td:nth-child(4),
    .delivery-table tbody td:nth-child(5),
    .delivery-table tfoot td:nth-child(4),
    .delivery-table tfoot td:nth-child(5){
      background: rgba(34,197,94,.07);
    }

    /* ✅ pkg width */
    .delivery-table th:first-child,
    .delivery-table td:first-child{
      width: 240px;
      text-align:left;
      white-space: normal;
      word-break: break-word;
    }
    .pkg-cell{
      font-weight: 1000;
      color: #0f172a;
      background: linear-gradient(180deg, rgba(248,250,252,1), rgba(241,245,249,1));
      transition: background .15s ease;
    }

    .serial-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 20px;
      padding: 1px 4px;
      border-radius: 999px;
      background: rgba(37,99,235,.12);
      border: 1px solid rgba(37,99,235,.22);
      color: #1d4ed8;
      font-size: 8.6px;
      font-weight: 1000;
      margin-right: 6px;
    }

    .qty-inp{
      width: 48px;
      padding: 3px 3px;
      border-radius: 9px;
      border: 1px solid rgba(229,231,235,.95);
      font-weight: 1000;
      font-size: 9.6px;
      outline: none;
      text-align: center;
      color: rgba(15,23,42,.92);
      background: rgba(255,255,255,.96);
      box-shadow: none;
    }
    .qty-inp:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 2px rgba(37,99,235,.10);
    }

    .sellpcs-cell{
      font-weight: 1000;
      color:#065f46;
      background: rgba(16,185,129,.07);
    }
    .money-cell{
      font-weight: 1000;
      color:#b42318;
      background: rgba(239,68,68,.07);
    }

    .delivery-table tfoot td{
      font-size: 9.2px;
      font-weight: 1000;
      background: #fff;
      border-top: 2px solid rgba(15,23,42,.12);
    }
    .totals-label{
      text-align:left !important;
      background: linear-gradient(180deg, rgba(15,23,42,.04), rgba(15,23,42,.02));
    }
    .tot-sellpcs{ background: rgba(16,185,129,.10); color:#065f46; }
    .tot-money{ background: rgba(239,68,68,.10); color:#b42318; }

    /* ✅ totals row thicker + bigger text */
    .delivery-table tfoot tr td{
      border-top: 3px solid rgba(15,23,42,.25) !important;
      font-size: 10.8px !important;
      padding: 6px 4px !important;
      font-weight: 1000 !important;
    }

    /* ✅ row hover/touch highlight */
    .delivery-table tbody tr{ transition: background .15s ease; }
    .delivery-table tbody tr:hover td{ background: rgba(37,99,235,.06); }
    .delivery-table tbody tr.active-row td{ background: rgba(37,99,235,.08) !important; }

    /* ✅ PDF mode: prevent sticky overlapping + keep text clean */
    body.pdf-mode .delivery-table{ font-size: 8.2px; }
    body.pdf-mode .delivery-table th,
    body.pdf-mode .delivery-table td{ padding: 2.4px 2.4px; }
    body.pdf-mode .delivery-table thead th{
      font-size: 8.2px;
      padding: 4px 2.4px;
      position: static !important;   /* ✅ IMPORTANT: no sticky in PDF snapshot */
      top: auto !important;
      box-shadow: none !important;
    }
    body.pdf-mode .qty-inp{ width: 44px; padding: 2.6px 2.6px; font-size: 9px; }
    body.pdf-mode .print-header{ font-size: 11px; padding: 4px 4px 8px 4px; }
    body.pdf-mode .print-header small{ font-size: 9px; }

    /* ✅ Print/PDF: hide buttons only */
    @media print{
      .no-print{ display:none !important; }
      body{ padding-top: 0 !important; background: #fff !important; }
      .wrap{ padding: 0 !important; }
      .card{ box-shadow:none !important; border: none !important; padding: 0 !important; }
      .delivery-table-wrap{ border: none !important; border-radius: 0 !important; }
      .print-header{ padding: 0 0 6px 0 !important; }
    }
    @page{
      size: A4 landscape;
      margin: 6mm;
    }

    /* =========================
       ✅ NEW: Better centered Loading (NOT inside print area)
       ========================= */
    .loading-layer{
      position: fixed;
      inset:0;
      z-index: 300;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background:
        radial-gradient(900px 520px at 15% 10%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(900px 520px at 85% 20%, rgba(16,185,129,.12), transparent 60%),
        rgba(15,23,42,.16);
      backdrop-filter: blur(10px);
    }
    .loading-layer.show{ display:flex; }

    .loading-box{
      width: min(380px, 92%);
      border-radius: 20px;
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(229,231,235,.95);
      box-shadow: 0 40px 140px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .loading-head{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(229,231,235,.9);
    }
    .loading-title{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 1000;
      color:#0f172a;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .ring{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 3px solid rgba(37,99,235,.18);
      border-top-color: rgba(37,99,235,1);
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .loading-body{
      padding: 14px 14px 14px 14px;
    }
    .pulse-line{
      height: 12px;
      border-radius: 999px;
      background: rgba(148,163,184,.22);
      position: relative;
      overflow:hidden;
    }
    .pulse-line::after{
      content:"";
      position:absolute;
      top:0; left:-40%;
      height:100%;
      width:40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.70), transparent);
      animation: shimmer 1.05s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%{ left:-45%; }
      100%{ left: 120%; }
    }
    .dots{
      display:flex;
      gap: 6px;
      margin-top: 12px;
      align-items:center;
    }
    .dot{
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(37,99,235,.35);
      animation: bounce 0.9s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay:.12s; background: rgba(16,185,129,.35); }
    .dot:nth-child(3){ animation-delay:.24s; background: rgba(37,99,235,.35); }
    @keyframes bounce{
      0%,100%{ transform: translateY(0); opacity:.65; }
      50%{ transform: translateY(-6px); opacity: 1; }
    }
    .loading-note{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(15,23,42,.62);
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.18);
      color:#0d47a1;
      font-weight: 1000;
      white-space: nowrap;
    }

    /* =========================
       ✅ PDF confirm modal
       ========================= */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      z-index: 200;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    .modal.show{ display:flex; }
    .modal-box{
      width: min(420px, 92%);
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 18px;
      box-shadow: 0 40px 120px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-head{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(229,231,235,.9);
    }
    .modal-title{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 1000;
      color:#0f172a;
      font-size: 15px;
    }
    .modal-body{
      padding: 12px 14px 6px 14px;
      color:#0f172a;
      font-weight: 900;
      font-size: 13px;
      line-height: 1.35;
    }
    .modal-sub{
      margin-top: 6px;
      color: rgba(15,23,42,.62);
      font-weight: 900;
      font-size: 12px;
    }
    .modal-actions{
      padding: 12px 14px 14px 14px;
      display:flex;
      gap: 10px;
    }
    .m-btn{
      flex:1;
      border: none;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 1000;
      font-size: 12px;
      padding: 11px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .m-btn:active{ transform: scale(.99); }
    .m-btn[disabled]{ opacity:.65; cursor:not-allowed; transform:none; }
    .m-cancel{ background: linear-gradient(135deg, rgba(239,68,68,1), rgba(244,63,94,1)); color:#fff; }
    .m-save{ background: linear-gradient(135deg, rgba(22,163,74,1), rgba(34,197,94,1)); color:#fff; }
  </style>
</head>

<body>
  <div class="topbar no-print">
    <div class="title-box">
      <div class="title" id="headlineTitle">Delivery Form</div>
      <div class="sub" id="headlineSub">ডেলিভারি ফর্ম</div>
    </div>

    <div class="meta">
      <div class="date-box">
        <label>তারিখ</label>
        <input type="date" id="deliveryDate">
      </div>

      <button class="btn btn-pdf" id="pdfBtn" onclick="openPdfConfirm()">
        <i class="fa-solid fa-file-pdf"></i> PDF
      </button>

      <button class="btn btn-save" id="saveBtn" onclick="saveDeliverySmart()">
        <i class="fa-solid fa-floppy-disk"></i> Save
      </button>

      <button class="btn btn-back" onclick="goBackToMain()">
        <i class="fa-solid fa-xmark"></i> Cancel
      </button>
    </div>
  </div>

  <div class="wrap">
    <div class="card" id="printArea">
      <div class="print-header" id="pdfHeader">
        <div id="pdfHeaderLine">গ্রহীতা: ...</div>
        <small id="pdfHeaderDate">তারিখ: ...</small>
      </div>

      <div class="delivery-table-wrap">
        <table class="delivery-table">
          <thead>
            <tr>
              <th rowspan="2">প্যাকেজের নাম</th>
              <th colspan="2">বহির পণ্য</th>
              <th colspan="2">ফেরত পণ্য</th>
              <th rowspan="2"> মোট পিস</th>
              <th rowspan="2">টাকা</th>
            </tr>
            <tr>
              <th>কেস</th>
              <th>পিস</th>
              <th>কেস</th>
              <th>পিস</th>
            </tr>
          </thead>
          <tbody id="deliveryPkgTbody"></tbody>
          <tfoot>
            <tr>
              <td class="totals-label">মোট</td>
              <td></td><td></td><td></td><td></td>
              <td class="tot-sellpcs" id="totalSellPcsCell">0</td>
              <td class="tot-money" id="totalMoneyCell">৳0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- ✅ Better centered Loading -->
  <div id="loadingLayer" class="loading-layer" aria-hidden="true">
    <div class="loading-box">
      <div class="loading-head">
        <div class="loading-title">
          <span class="ring"></span>
          প্রসেস হচ্ছে...
        </div>
        <div class="badge">Please wait</div>
      </div>
      <div class="loading-body">
        <div class="pulse-line" style="width: 78%;"></div>
        <div class="pulse-line" style="width: 92%; margin-top:10px;"></div>
        <div class="dots">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
        <div class="loading-note">
          <span>ডাটা/পিডিএফ প্রস্তুত করা হচ্ছে</span>
          <span class="badge">Working</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ PDF Confirm Modal -->
  <div id="pdfConfirmModal" class="modal" onclick="closePdfConfirmFromOverlay(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">
          <i class="fa-solid fa-file-pdf" style="color:#16a34a;"></i>
          পিডিএফ সেভ করুন
        </div>
        <div style="font-weight:1000;color:rgba(15,23,42,.55);font-size:12px;">Ready</div>
      </div>
      <div class="modal-body">
        আপনার ডেলিভারি ফর্মটি PDF হিসেবে সেভ করতে চান?
        <div class="modal-sub">Save চাপলে PDF ডাউনলোড হবে।</div>
      </div>
      <div class="modal-actions">
        <button class="m-btn m-cancel" onclick="closePdfConfirm()">
          <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button class="m-btn m-save" id="pdfSaveConfirmBtn" onclick="confirmSavePDF()">
          <i class="fa-solid fa-download"></i> Save
        </button>
      </div>
    </div>
  </div>

<script type="module">
  import { database } from './firebase-config.js';
  import { ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  /* ========= helpers ========= */
  const qs = new URLSearchParams(location.search);
  const urlPerson = (qs.get("person") || "").trim();
  const urlDate = (qs.get("date") || "").trim();
  const urlGroupId = (qs.get("groupId") || "").trim();

  const returnUrl = decodeURIComponent(qs.get("returnUrl") || "");

  const todayISO = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  };

  const safeNum = (v) => {
    const n = parseInt(v, 10);
    return isNaN(n) ? 0 : n;
  };

  const pcsFromCasePcs = (cases, pcs, caseQty) => {
    const cq = parseInt(caseQty) || 1;
    return (safeNum(cases) * cq) + safeNum(pcs);
  };

  const splitToCasePcs = (totalPcs, caseQty) => {
    const cq = parseInt(caseQty) || 1;
    const t = safeNum(totalPcs);
    const c = cq ? Math.floor(t / cq) : 0;
    const p = cq ? (t % cq) : t;
    return { c, p };
  };

  const getPkgSerial = (p) => {
    const v = p?.serial ?? p?.sl ?? p?.no ?? p?.order ?? p?.id;
    const n = parseInt(v, 10);
    return isNaN(n) ? null : n;
  };

  const ddmmyyyy = (iso) => {
    if(!iso) return "";
    const [y,m,d] = iso.split("-");
    return `${d}-${m}-${y}`;
  };

  const sanitizeFile = (s) => (s || "").replace(/[\\/:*?"<>|]/g, "_").trim();

  /* ========= state ========= */
  let packages = {};
  let deliveryRows = [];

  let selectedPersonName = urlPerson || "";
  let currentDeliveryGroupId = urlGroupId || "";
  let currentEditingGroupId = urlGroupId || "";
  let currentCashData = 0;
  let currentDuesData = [];

  /* ========= loading controls ========= */
  function showLoading(){
    const el = document.getElementById("loadingLayer");
    if (el) el.classList.add("show");
  }
  function hideLoading(){
    const el = document.getElementById("loadingLayer");
    if (el) el.classList.remove("show");
  }
  function setButtonsDisabled(disabled){
    const pdfBtn = document.getElementById("pdfBtn");
    const saveBtn = document.getElementById("saveBtn");
    const pdfSaveBtn = document.getElementById("pdfSaveConfirmBtn");
    if (pdfBtn) pdfBtn.disabled = !!disabled;
    if (saveBtn) saveBtn.disabled = !!disabled;
    if (pdfSaveBtn) pdfSaveBtn.disabled = !!disabled;
  }

  /* ========= UI init ========= */
  const dateInput = document.getElementById("deliveryDate");
  dateInput.value = urlDate || todayISO();

  function setHeadline(){
    const dmy = ddmmyyyy(dateInput.value || "");
    const person = selectedPersonName || "N/A";

    document.getElementById("headlineTitle").innerText = `Delivery Form`;
    document.getElementById("headlineSub").innerText = `ডেলিভারি ফর্ম`;

    document.getElementById("pdfHeaderLine").innerText = `${person}${dmy ? " (" + dmy + ")" : ""}`;
    document.getElementById("pdfHeaderDate").innerText = dmy ? `তারিখ: ${dmy}` : "";
  }
  setHeadline();

  dateInput.addEventListener("change", () => setHeadline());

  /* ========= row highlight for touch ========= */
  function bindRowHighlight(){
    const tbody = document.getElementById('deliveryPkgTbody');
    if (!tbody) return;

    tbody.addEventListener('touchstart', (e) => {
      const tr = e.target.closest('tr');
      if (!tr) return;
      tbody.querySelectorAll('tr.active-row').forEach(x => x.classList.remove('active-row'));
      tr.classList.add('active-row');
    }, { passive:true });

    tbody.addEventListener('mousedown', (e) => {
      const tr = e.target.closest('tr');
      if (!tr) return;
      tbody.querySelectorAll('tr.active-row').forEach(x => x.classList.remove('active-row'));
      tr.classList.add('active-row');
    });
  }

  /* ========= load packages + then load group transactions ========= */
  showLoading();

  onValue(ref(database, 'packages'), async (snapshot) => {
    packages = {};
    snapshot.forEach(child => { packages[child.key] = { ...child.val(), key: child.key }; });

    buildDeliveryRowsFromPackages();
    await hydrateExistingGroupIfAny();

    renderDeliveryTable();
    bindRowHighlight();

    hideLoading();
  });

  async function hydrateExistingGroupIfAny(){
    if(!currentEditingGroupId) return;

    const snap = await get(ref(database, 'transactions'));
    if(!snap.exists()) return;

    const items = [];
    snap.forEach(ch => {
      const v = ch.val() || {};
      if ((v.groupId || "").trim() === currentEditingGroupId) items.push({ key: ch.key, ...v });
    });
    if (!items.length) return;

    if (!selectedPersonName) selectedPersonName = items[0].personName || "";
    if (!dateInput.value) dateInput.value = items[0].date || todayISO();
    setHeadline();

    currentCashData = parseFloat(items[0]?.cashReceived || 0) || 0;
    currentDuesData = items[0]?.dues || [];

    const savedSaleConfirmed = items.some(x => x.saleConfirmed === true);

    items.forEach(item => {
      const row = deliveryRows.find(r => (r.pkgName || "") === (item.pkgName || ""));
      if(!row) return;

      const tq = parseInt(item.totalPcs) || 0;
      if((item.type || "Out") === "Out"){
        const sp = splitToCasePcs(tq, row.caseQty);
        row.outCase = sp.c; row.outPcs = sp.p;
        row.outKey = item.key;
        row.appliedSellPcs = parseInt(item.appliedSellPcs || 0) || 0;
      }else{
        const sp = splitToCasePcs(tq, row.caseQty);
        row.retCase = sp.c; row.retPcs = sp.p;
        row.returnKey = item.key;
      }
      row.retTouched = savedSaleConfirmed;
    });
  }

  function buildDeliveryRowsFromPackages() {
    deliveryRows = Object.values(packages)
      .map(p => ({
        pkgKey: p.key,
        pkgName: p.name || "",
        caseQty: parseInt(p.caseQty) || 1,
        sellPrice: parseFloat(p.sellPrice) || 0,
        stock: parseInt(p.stock) || 0,
        serial: getPkgSerial(p),

        outCase: 0, outPcs: 0,
        retCase: 0, retPcs: 0,

        outKey: null,
        returnKey: null,
        appliedSellPcs: 0,

        retTouched: false
      }))
      .sort((a,b) => {
        const as = (a.serial == null) ? 999999 : a.serial;
        const bs = (b.serial == null) ? 999999 : b.serial;
        if (as !== bs) return as - bs;
        return (a.pkgName || "").localeCompare(b.pkgName || "");
      });
  }

  function computeSellAndAmountAlways(r){
    const outTotal = pcsFromCasePcs(r.outCase, r.outPcs, r.caseQty);
    const retTotal = pcsFromCasePcs(r.retCase, r.retPcs, r.caseQty);
    const sellPcs = Math.max(0, outTotal - retTotal);
    const amtNum = sellPcs * (parseFloat(r.sellPrice)||0);
    return { sellPcs: String(sellPcs), amt: "৳"+amtNum.toFixed(2) };
  }

  function updateTotalsLive(){
    let totalSell = 0;
    let totalMoney = 0;

    deliveryRows.forEach(r => {
      const outTotal = pcsFromCasePcs(r.outCase, r.outPcs, r.caseQty);
      const retTotal = pcsFromCasePcs(r.retCase, r.retPcs, r.caseQty);
      const sellPcs = Math.max(0, outTotal - retTotal);
      totalSell += sellPcs;
      totalMoney += sellPcs * (parseFloat(r.sellPrice)||0);
    });

    document.getElementById('totalSellPcsCell').innerText = String(totalSell);
    document.getElementById('totalMoneyCell').innerText = "৳" + totalMoney.toFixed(2);
  }

  function renderDeliveryTable() {
    const tb = document.getElementById('deliveryPkgTbody');
    tb.innerHTML = "";

    deliveryRows.forEach((r, idx) => {
      const computed = computeSellAndAmountAlways(r);

      const outCaseVal = r.outCase > 0 ? r.outCase : "";
      const outPcsVal  = r.outPcs  > 0 ? r.outPcs  : "";
      const retCaseVal = r.retCase > 0 ? r.retCase : "";
      const retPcsVal  = r.retPcs  > 0 ? r.retPcs  : "";

      tb.innerHTML += `
        <tr>
          <td class="pkg-cell">
            ${r.serial != null ? `<span class="serial-badge">${r.serial}</span>` : ``}
            ${r.pkgName || ""}
          </td>

          <td><input class="qty-inp" type="number" min="0" value="${outCaseVal}" placeholder="-" data-idx="${idx}" data-field="outCase"></td>
          <td><input class="qty-inp" type="number" min="0" value="${outPcsVal}"  placeholder="-" data-idx="${idx}" data-field="outPcs"></td>

          <td><input class="qty-inp" type="number" min="0" value="${retCaseVal}" placeholder="-" data-idx="${idx}" data-field="retCase"></td>
          <td><input class="qty-inp" type="number" min="0" value="${retPcsVal}"  placeholder="-" data-idx="${idx}" data-field="retPcs"></td>

          <td class="sellpcs-cell"><span id="sellpcs-${idx}">${computed.sellPcs}</span></td>
          <td class="money-cell" id="amt-${idx}">${computed.amt}</td>
        </tr>
      `;
    });

    bindLiveInputs();
    updateTotalsLive();
  }

  let inputsBound = false;
  function bindLiveInputs(){
    if(inputsBound) return;
    inputsBound = true;

    const tbody = document.getElementById('deliveryPkgTbody');
    tbody.addEventListener('input', (e) => {
      const el = e.target;
      if (!el || el.tagName !== "INPUT") return;
      if (el.type !== "number") return;

      const idx = parseInt(el.dataset.idx, 10);
      const field = el.dataset.field;
      if (isNaN(idx) || !field || !deliveryRows[idx]) return;

      if (field === "retCase" || field === "retPcs") {
        const v = String(el.value ?? "").trim();
        if (v !== "") deliveryRows[idx].retTouched = true;
      }

      deliveryRows[idx][field] = safeNum(el.value);

      const { sellPcs, amt } = computeSellAndAmountAlways(deliveryRows[idx]);
      const spEl = document.getElementById(`sellpcs-${idx}`);
      const amEl = document.getElementById(`amt-${idx}`);
      if (spEl) spEl.innerText = sellPcs;
      if (amEl) amEl.innerText = amt;

      updateTotalsLive();
    });
  }

  /* ========= PDF confirm modal ========= */
  window.openPdfConfirm = () => {
    document.getElementById("pdfConfirmModal").classList.add("show");
  };
  window.closePdfConfirm = () => {
    document.getElementById("pdfConfirmModal").classList.remove("show");
  };
  window.closePdfConfirmFromOverlay = (e) => {
    if (e.target && e.target.id === "pdfConfirmModal") closePdfConfirm();
  };

  let pdfBusy = false;

  window.confirmSavePDF = async () => {
    if (pdfBusy) return;
    pdfBusy = true;

    closePdfConfirm();
    showLoading();
    setButtonsDisabled(true);

    try{
      await window.saveAsPDF();   // ✅ FIX: call window.saveAsPDF (no ReferenceError)
    }catch(e){
      alert("PDF সেভ করা যায়নি!");
    }finally{
      setButtonsDisabled(false);
      hideLoading();
      pdfBusy = false;
    }
  };

  /* ========= SAVE (unchanged logic) ========= */
  window.saveDeliverySmart = async () => {
    showLoading();
    setButtonsDisabled(true);

    const date = dateInput.value || todayISO();
    if(!selectedPersonName){
      hideLoading();
      setButtonsDisabled(false);
      return alert("গ্রহীতা পাওয়া যায়নি!");
    }

    if (!currentDeliveryGroupId) {
      currentDeliveryGroupId = `g_${date}_${selectedPersonName}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      setHeadline();
    }

    const saleConfirmed = deliveryRows.some(r => r.retTouched);

    const retMode =
      saleConfirmed ||
      deliveryRows.some(r => pcsFromCasePcs(r.retCase, r.retPcs, r.caseQty) > 0) ||
      (!!currentEditingGroupId);

    if (!retMode) {
      try{
        for (const r of deliveryRows) {
          const outTotal = pcsFromCasePcs(r.outCase, r.outPcs, r.caseQty);
          if (outTotal <= 0) continue;

          const payload = {
            groupId: currentDeliveryGroupId,
            personName: selectedPersonName,
            date,
            type: "Out",
            pkgName: r.pkgName,
            totalPcs: outTotal,
            pkgSellPrice: r.sellPrice,
            amount: (outTotal * r.sellPrice).toFixed(2),
            cashReceived: currentCashData,
            dues: currentDuesData,
            appliedSellPcs: r.appliedSellPcs || 0,
            saleConfirmed: false
          };

          if (r.outKey) await update(ref(database, `transactions/${r.outKey}`), payload);
          else {
            const pushed = await push(ref(database, 'transactions'), payload);
            r.outKey = pushed.key;
          }
        }

        alert("✅ বহির পণ্য সেভ হয়েছে (স্টক কাটেনি)!");
        returnToMainAfterSave();
      }catch(e){
        alert(e.message);
      }finally{
        hideLoading();
        setButtonsDisabled(false);
      }
      return;
    }

    try{
      for (const r of deliveryRows) {
        const outTotal = pcsFromCasePcs(r.outCase, r.outPcs, r.caseQty);
        const retTotal = pcsFromCasePcs(r.retCase, r.retPcs, r.caseQty);

        if (outTotal <= 0 && retTotal <= 0 && !r.outKey && !r.returnKey) continue;

        if (outTotal > 0) {
          const outPayload = {
            groupId: currentDeliveryGroupId,
            personName: selectedPersonName,
            date,
            type: "Out",
            pkgName: r.pkgName,
            totalPcs: outTotal,
            pkgSellPrice: r.sellPrice,
            amount: (outTotal * r.sellPrice).toFixed(2),
            cashReceived: currentCashData,
            dues: currentDuesData,
            appliedSellPcs: r.appliedSellPcs || 0,
            saleConfirmed: saleConfirmed
          };
          if (r.outKey) await update(ref(database, `transactions/${r.outKey}`), outPayload);
          else {
            const pushed = await push(ref(database, 'transactions'), outPayload);
            r.outKey = pushed.key;
          }
        }

        if (retTotal > 0) {
          const retPayload = {
            groupId: currentDeliveryGroupId,
            personName: selectedPersonName,
            date,
            type: "Return",
            pkgName: r.pkgName,
            totalPcs: retTotal,
            pkgSellPrice: r.sellPrice,
            amount: (retTotal * r.sellPrice).toFixed(2),
            cashReceived: currentCashData,
            dues: currentDuesData,
            saleConfirmed: saleConfirmed
          };
          if (r.returnKey) await update(ref(database, `transactions/${r.returnKey}`), retPayload);
          else {
            const pushed = await push(ref(database, 'transactions'), retPayload);
            r.returnKey = pushed.key;
          }
        } else if (r.returnKey) {
          await remove(ref(database, `transactions/${r.returnKey}`));
          r.returnKey = null;
        }

        const netSell = Math.max(0, outTotal - retTotal);

        let oldApplied = 0;
        if (r.outKey) {
          const outSnap = await get(ref(database, `transactions/${r.outKey}`));
          oldApplied = parseInt(outSnap.val()?.appliedSellPcs || 0) || 0;
        } else {
          oldApplied = parseInt(r.appliedSellPcs || 0) || 0;
        }

        const diff = netSell - oldApplied;
        if (diff !== 0) {
          const pkg = packages[r.pkgKey];
          const currentStock = parseInt(pkg?.stock) || 0;
          const newStock = currentStock - diff;
          await update(ref(database, `packages/${r.pkgKey}`), { stock: newStock });

          packages[r.pkgKey].stock = newStock;
          r.stock = newStock;
        }

        if (r.outKey) await update(ref(database, `transactions/${r.outKey}`), { appliedSellPcs: netSell, groupId: currentDeliveryGroupId, saleConfirmed });
        r.appliedSellPcs = netSell;
      }

      alert("✅ সেভ হয়েছে + সেল পিস অনুযায়ী স্টক আপডেট হয়েছে!");
      returnToMainAfterSave();
    }catch(e){
      alert(e.message);
    }finally{
      hideLoading();
      setButtonsDisabled(false);
    }
  };

  function returnToMainAfterSave(){
    if (returnUrl) {
      location.href = returnUrl;
      return;
    }
    history.back();
  }

  /* ========= PDF (direct download, no print dialog) ========= */
  window.saveAsPDF = async () => {
    // ✅ always refresh totals/header before capture
    updateTotalsLive();
    setHeadline();

    const dateISO = dateInput.value || "";
    const dmy = ddmmyyyy(dateISO);
    const name = sanitizeFile(selectedPersonName || "Delivery");
    const filename = `${name}${dmy}.pdf`;

    const el = document.getElementById("printArea");

    // ✅ PDF mode on
    document.body.classList.add("pdf-mode");

    // ✅ IMPORTANT: avoid weird offsets in capture
    const opt = {
      margin:       [6, 6, 6, 6],
      filename:     filename,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        scrollY: 0,
        scrollX: 0,
        letterRendering: true
      },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' },
      pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
    };

    try{
      // ✅ ensure layout is stable
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      await html2pdf().set(opt).from(el).save();
      return true;
    }finally{
      // ✅ always cleanup (fix "one click then dead")
      document.body.classList.remove("pdf-mode");
    }
  };

  /* ✅ Cancel works same-tab */
  window.goBackToMain = () => {
    if (returnUrl) {
      location.href = returnUrl;
      return;
    }
    history.back();
  };
</script>

</body>
</html>
