<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡¶¨‡¶æ‡¶ï‡ßÄ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ - Hisab</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;

      --brand:#2563eb;
      --brand2:#60a5fa;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 2px 10px rgba(15,23,42,.08);

      --r14:14px;
      --r18:18px;

      --topbar-h: 80px;

      /* Sidebar width (like screenshot) */
      --sb-w: 295px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(16,185,129,.06), transparent 55%),
        var(--bg);
      padding-top: var(--topbar-h);
      color: var(--text);
    }

    /* ===== Navbar ===== */
    .navbar{
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229,231,235,.9);
      box-shadow: 0 8px 30px rgba(15,23,42,.06);
      padding: 14px 16px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 10;

      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .menu-icon{
      position:absolute;
      left: 14px;
      width:42px; height:42px;
      display:grid;
      place-items:center;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(37,99,235,.12), rgba(37,99,235,.06));
      color: var(--brand);
      font-size: 20px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .navbar h1{
      font-size: 18px;
      margin:0;
      font-weight: 1000;
      color: #0f172a;
      letter-spacing:.2px;
    }

    /* ===== Sidebar + overlay (like your screenshot) ===== */
    .sidebar-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      z-index: 80;
      opacity:0;
      pointer-events:none;
      transition:.2s;
    }
    .sidebar-overlay.show{
      opacity:1;
      pointer-events:auto;
    }

    .sidebar{
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sb-w);
      height: 100%;
      transform: translateX(-110%);
      transition: .28s ease;
      z-index: 90;

      background: linear-gradient(180deg, #0b1224 0%, #0f172a 45%, #0b1224 100%);
      box-shadow: 0 30px 80px rgba(0,0,0,.28);

      padding: 14px 14px 18px 14px;
      overflow:auto;
    }
    .sidebar.open{ transform: translateX(0); }

    /* sidebar header */
    .sb-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 8px 4px 12px 4px;
    }
    .sb-title{
      color:#fff;
      font-weight: 1000;
      font-size: 20px;
      line-height: 1.1;
      margin: 2px 0 0 0;
    }
    .sb-sub{
      color: rgba(255,255,255,.65);
      font-weight: 800;
      font-size: 12px;
      margin-top: 4px;
    }
    .sb-close{
      width:44px; height:44px;
      border:none;
      border-radius: 16px;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      color:#fff;
      display:grid;
      place-items:center;
      font-size: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .sb-close:active{ transform: scale(.98); }

    .sb-divider{
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 10px 0 14px 0;
    }

    .sb-links{ display:flex; flex-direction:column; gap: 12px; }

    .sb-item{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 14px 14px;
      border-radius: 16px;

      color: rgba(255,255,255,.92);
      text-decoration:none;
      font-weight: 1000;
      font-size: 15px;

      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      transition: .18s;
    }
    .sb-item:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }
    .sb-ic{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 16px;
    }

    /* ===== Main layout ===== */
    .main-container { padding: 14px; max-width: 1200px; margin: 0 auto; }

    /* ===== Card/Table ===== */
    .table-card{
      background: rgba(255,255,255,.90);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative; /* ‚úÖ NEW: loader overlay anchor */
    }

    .table-header{
      padding: 14px 14px;
      background: rgba(255,255,255,.7);
      border-bottom: 1px solid rgba(229,231,235,.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .table-header h3{
      margin:0;
      font-size: 15px;
      font-weight: 1000;
      color:#0f172a;
    }

    .add-baki-btn{
      background: linear-gradient(135deg, rgba(245,158,11,1), rgba(251,191,36,1));
      color: #111827;
      border:none;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 1000;
      transition:.15s;
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .add-baki-btn:active{ transform: scale(.99); }

    /* ===== Filter Bar ===== */
    .filter-bar{
      padding: 12px 14px;
      background: rgba(255,255,255,.75);
      border-bottom: 1px solid rgba(229,231,235,.9);
      display:flex;
      gap: 12px;
      align-items:flex-end;
      flex-wrap: wrap;
    }
    .filter-item{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 170px;
    }
    .filter-item label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }
    .filter-item input, .filter-item select{
      padding: 12px;
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 14px;
      font-size: 14px;
      background:#fff;
      font-family: inherit;
      font-weight: 800;
      outline:none;
    }
    .filter-item input:focus, .filter-item select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .range-box{ min-width: 270px; }
    .range-toggle{ cursor:pointer; background: #fff; }
    .range-panel{ display:none; margin-top: 6px; gap: 10px; }
    .range-panel.open{ display:flex; }
    .range-panel input{ min-width: 0; width: 100%; }

    .total-due-box{
      margin-left: auto;
      background: rgba(37,99,235,.06);
      border: 1px solid rgba(37,99,235,.18);
      padding: 10px 12px;
      border-radius: 16px;
      font-weight: 1000;
      color: #0f172a;
      min-width: 220px;
      text-align:center;
      box-shadow: 0 2px 10px rgba(15,23,42,.05);
    }
    .total-due-box span{ color: #0d47a1; }

    /* ===== Table ===== */
    .table-container{ width:100%; overflow-x:auto; }
    table{ width:100%; border-collapse: collapse; white-space: nowrap; font-size: 14px; }
    thead th{
      position: sticky;
      top: 0;
      z-index: 1;
      background: linear-gradient(135deg, #0f172a, #1f2937);
      color: white;
      padding: 12px 14px;
      text-align: center;
      font-weight: 1000;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    tbody td{
      padding: 12px 14px;
      text-align:center;
      border-bottom: 1px solid rgba(229,231,235,.9);
      font-weight: 800;
      color:#111827;
    }

    tbody tr:nth-child(even){ background-color: rgba(37,99,235,.03); }
    tbody tr:nth-child(odd){ background-color: rgba(255,255,255,.92); }

    /* Status Badges */
    .status-badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 1000;
      display:inline-block;
      border: 1px solid rgba(0,0,0,.06);
    }
    .pending{ background: rgba(245,158,11,.15); color: #7c5208; border-color: rgba(245,158,11,.25); }
    .completed{ background: rgba(22,163,74,.14); color: #14532d; border-color: rgba(22,163,74,.22); }

    /* Action Button */
    .action-btn{
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(96,165,250,1));
      color: white;
      border:none;
      padding: 9px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition:.15s;
      box-shadow: var(--shadow2);
      font-weight: 1000;
      display:inline-flex;
      align-items:center;
      gap: 7px;
      white-space: nowrap;
    }
    .action-btn:active{ transform: scale(.99); }

    /* ‚úÖ NEW: Delete button style (kept minimal, no layout change) */
    .delete-btn{
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(244,63,94,1));
      color: white;
      border:none;
      padding: 9px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition:.15s;
      box-shadow: var(--shadow2);
      font-weight: 1000;
      display:inline-flex;
      align-items:center;
      gap: 7px;
      white-space: nowrap;
      margin-left: 8px;
    }
    .delete-btn:active{ transform: scale(.99); }

    /* Column colors */
    .col-no{ font-weight: 1000; color: #64748b; }
    .col-date{ color: #334155; }
    .col-person{ color: #0d47a1; font-weight: 1000; }
    .col-shop{ color: #6a1b9a; font-weight: 1000; }
    .col-baki{ color: #b91c1c; font-weight: 1000; }
    .col-paid{ color: #166534; font-weight: 1000; }
    .col-due{ color: #ea580c; font-weight: 1000; }
    .col-desc{ color: #334155; font-weight: 900; } /* ‚úÖ NEW */

    /* Pagination */
    .pagination-bar{
      padding: 14px 14px;
      background: rgba(255,255,255,.75);
      border-top: 1px solid rgba(229,231,235,.9);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .pager{ display:flex; align-items:center; gap: 8px; flex-wrap: wrap; }
    .page-btn{
      border: 1px solid rgba(229,231,235,.95);
      background: #fff;
      color: #111827;
      padding: 8px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 1000;
      min-width: 44px;
      text-align:center;
      transition:.15s;
      user-select:none;
      box-shadow: 0 2px 10px rgba(15,23,42,.04);
    }
    .page-btn:hover{ transform: translateY(-1px); }
    .page-btn.active{
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(96,165,250,1));
      border-color: rgba(37,99,235,1);
      color:#fff;
    }
    .page-btn.disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }
    .page-ellipsis{ padding: 8px 6px; color: #64748b; font-weight: 1000; }

    .page-size{ margin-left:auto; display:flex; align-items:center; gap: 8px; }
    .page-size select{
      padding: 10px 12px;
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 14px;
      font-size: 14px;
      background:#fff;
      font-weight: 1000;
      outline:none;
    }

    /* ===== Modal ===== */
    .modal{
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.60);
      z-index:100;
      justify-content:center;
      align-items:center;
      padding: 16px;
    }
    .modal-content{
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(229,231,235,.9);
      padding: 18px;
      border-radius: 18px;
      width: 92%;
      max-width: 420px;
      box-shadow: 0 40px 120px rgba(0,0,0,.25);
    }
    .modal-content h3{
      margin: 0 0 10px 0;
      color:#0f172a;
      font-weight: 1000;
      text-align:center;
      font-size: 16px;
    }
    .modal-content p{ margin:0 0 10px 0; }

    .modal-content input, .modal-content select{
      width:100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 14px;
      font-size: 15px;
      font-weight: 900;
      outline:none;
    }
    .modal-content input:focus, .modal-content select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .modal-btns{ display:flex; gap: 10px; margin-top: 8px; }
    .save-btn{
      flex:1;
      background: linear-gradient(135deg, rgba(22,163,74,1), rgba(34,197,94,1));
      color:white;
      border:none;
      padding: 12px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 1000;
      box-shadow: var(--shadow2);
    }
    .close-btn{
      flex:1;
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(244,63,94,1));
      color:white;
      border:none;
      padding: 12px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 1000;
      box-shadow: var(--shadow2);
    }

    /* Two input in one row */
    .row-2{ display:flex; gap: 10px; }
    .row-2 > *{ flex:1; }

    @media (max-width: 520px){
      .range-box{ min-width: 100%; }
      .filter-item{ min-width: 100%; }
      .total-due-box{ margin-left: 0; width: 100%; }
      .row-2{ flex-direction: column; }
      :root{ --sb-w: 280px; }
    }

    /* =========================
       ‚úÖ NEW: Modern Loading UI
       ========================= */
    .loading-layer{
      position:absolute;
      inset:0;
      z-index: 60;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(37,99,235,.10), transparent 60%),
        rgba(255,255,255,.70);
      backdrop-filter: blur(10px);
      border-radius: 18px;
    }
    .loading-card{
      width: min(560px, 96%);
      border-radius: 18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(229,231,235,.95);
      box-shadow: 0 30px 90px rgba(15,23,42,.12);
      overflow:hidden;
    }
    .loading-top{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(229,231,235,.9);
    }
    .loading-title{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 1000;
      color:#0f172a;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .spinner{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 3px solid rgba(37,99,235,.18);
      border-top-color: rgba(37,99,235,1);
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .loading-body{ padding: 12px 14px 14px 14px; }
    .skeleton{
      position: relative;
      overflow:hidden;
      background: rgba(148,163,184,.22);
      border-radius: 12px;
    }
    .skeleton::after{
      content:"";
      position:absolute;
      top:0; left:-40%;
      height:100%;
      width:40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: shimmer 1.1s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%{ left:-45%; }
      100%{ left: 120%; }
    }

    .sk-row{
      display:flex;
      gap: 10px;
      margin-top: 10px;
    }
    .sk-cell{ height: 12px; }
    .sk-1{ width: 18%; }
    .sk-2{ width: 24%; }
    .sk-3{ width: 30%; }
    .sk-4{ width: 16%; margin-left:auto; }

    .loading-hint{
      margin-top: 10px;
      font-size: 12px;
      color: #64748b;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .loading-pill{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.18);
      color:#0d47a1;
      font-weight: 1000;
      white-space: nowrap;
    }

    /* ==================================================
       ‚úÖ NEW: Laptop size full-width + bigger form controls
       ================================================== */
    @media (min-width: 1024px){
      .main-container{
        max-width: 100%;
        padding-left: 28px;
        padding-right: 28px;
      }

      .filter-item input,
      .filter-item select{
        padding: 14px 16px;
        font-size: 15px;
      }

      .range-toggle{
        padding: 14px 16px;
        font-size: 15px;
      }

      .page-size select{
        padding: 12px 14px;
        font-size: 15px;
      }

      .modal-content{
        max-width: 520px;
      }
      .modal-content input,
      .modal-content select{
        padding: 14px 16px;
        font-size: 16px;
      }

      .add-baki-btn{
        padding: 12px 16px;
        font-size: 15px;
      }
      .action-btn{
        padding: 11px 14px;
        font-size: 14px;
      }
      .save-btn,
      .close-btn{
        padding: 13px 16px;
        font-size: 15px;
      }

      table{ font-size: 15px; }
      thead th{ padding: 14px 16px; }
      tbody td{ padding: 14px 16px; }

      .page-btn{
        padding: 10px 14px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <!-- overlay -->
  <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebarFromOverlay()"></div>

  <!-- Navbar -->
  <div class="navbar">
    <span class="menu-icon" onclick="toggleSidebar(event)">‚ò∞</span>
    <h1>‡¶¨‡¶æ‡¶ï‡ßÄ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h1>
  </div>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <div class="sb-head">
      <div>
        <div class="sb-title">Baki Hisab</div>
        <div class="sb-sub">‡¶Æ‡ßá‡¶®‡ßÅ</div>
      </div>
      <button class="sb-close" onclick="closeSidebarFromOverlay()" aria-label="Close">‚úï</button>
    </div>
    <div class="sb-divider"></div>

    <div class="sb-links">
      <a class="sb-item" href="index.html">
        <span class="sb-ic">üè†</span> Dashboard
      </a>
      <a class="sb-item" href="hisab.html">
        <span class="sb-ic">üßæ</span> ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®
      </a>
      <a class="sb-item" href="stock.html">
        <span class="sb-ic">üì¶</span> ‡¶Æ‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ï
      </a>
      <a class="sb-item" href="today.html">
        <span class="sb-ic">üìÖ</span> ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßá‡¶≤
      </a>
      <a class="sb-item" href="baki.html">
        <span class="sb-ic">üßç</span> ‡¶¨‡¶æ‡¶ï‡ßÄ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨
      </a>
    </div>
  </div>

  <div class="main-container">
    <div class="table-card">

      <!-- Loading Layer -->
      <div id="loadingLayer" class="loading-layer">
        <div class="loading-card">
          <div class="loading-top">
            <div class="loading-title">
              <span class="spinner"></span>
              ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </div>
            <div class="loading-pill">Please wait</div>
          </div>

          <div class="loading-body">
            <div class="skeleton sk-cell" style="height:14px; width: 55%;"></div>

            <div class="sk-row">
              <div class="skeleton sk-cell sk-1"></div>
              <div class="skeleton sk-cell sk-2"></div>
              <div class="skeleton sk-cell sk-3"></div>
              <div class="skeleton sk-cell sk-4"></div>
            </div>
            <div class="sk-row">
              <div class="skeleton sk-cell sk-2"></div>
              <div class="skeleton sk-cell sk-3"></div>
              <div class="skeleton sk-cell sk-1"></div>
              <div class="skeleton sk-cell sk-4"></div>
            </div>
            <div class="sk-row">
              <div class="skeleton sk-cell sk-3"></div>
              <div class="skeleton sk-cell sk-1"></div>
              <div class="skeleton sk-cell sk-2"></div>
              <div class="skeleton sk-cell sk-4"></div>
            </div>

            <div class="loading-hint">
              <span>Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶®‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá</span>
              <span class="loading-pill">Syncing</span>
            </div>
          </div>
        </div>
      </div>

      <div class="table-header">
        <h3 style="margin:0">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶¨‡¶æ‡¶ï‡ßÄ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
        <button class="add-baki-btn" onclick="openAddBakiModal()">
          <i class="fas fa-plus"></i> Add Baki
        </button>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <div class="filter-item range-box">
          <label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (‡¶∞‡ßá‡¶û‡ßç‡¶ú)</label>
          <input class="range-toggle" id="rangeToggle" type="text" readonly value="‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®" onclick="toggleRangePanel()">
          <div id="rangePanel" class="range-panel">
            <input type="date" id="startDate" onchange="applyFilters(true)">
            <input type="date" id="endDate" onchange="applyFilters(true)">
          </div>
        </div>

        <div class="filter-item">
          <label>‡¶™‡¶æ‡¶∞‡¶∏‡ßã‡¶®</label>
          <select id="filterPerson" onchange="applyFilters(true)">
            <option value="">‡¶∏‡¶¨</option>
          </select>
        </div>

        <div class="filter-item">
          <label>‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶æ‡¶∏</label>
          <select id="filterStatus" onchange="applyFilters(true)">
            <option value="all">‡¶∏‡¶¨</option>
            <option value="complete">Complete</option>
            <option value="pending">Pending</option>
          </select>
        </div>

        <div class="total-due-box">
          ‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶ì‡¶®‡¶æ: <span id="totalDue">‡ß≥0.00</span>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
              <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
              <th>‡¶™‡¶æ‡¶∞‡¶∏‡ßã‡¶® ‡¶®‡¶æ‡¶Æ</th>
              <th>‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
              <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
              <th>‡¶¨‡¶æ‡¶ï‡ßÄ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶®</th>
              <th>‡¶ú‡¶Æ‡¶æ</th>
              <th>‡¶™‡¶æ‡¶ì‡¶®‡¶æ</th>
              <th>‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶æ‡¶∏</th>
              <th>‡¶è‡¶ï‡¶∂‡¶®</th>
            </tr>
          </thead>
          <tbody id="bakiTableBody"></tbody>
        </table>
      </div>

      <!-- Pagination Bar -->
      <div class="pagination-bar">
        <div class="pager" id="pager"></div>

        <div class="page-size">
          <select id="pageSizeSelect" onchange="changePageSize()">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Collection Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <h3>‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
      <p id="modalInfo" style="font-weight: 1000; color: #2563eb; margin: 0 0 10px 0;"></p>

      <!-- ‚úÖ NEW: show last collection info (date + amount) -->
      <p id="lastCollectionInfo" style="font-weight: 1000; color:#0f172a; margin: 0 0 10px 0; font-size: 13px;"></p>

      <label style="font-size:12px;color:#64748b;font-weight:900;">‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
      <input type="number" id="collectionInput" placeholder="0.00">
      <div class="modal-btns">
        <button class="save-btn" onclick="processCollection()">‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="close-btn" onclick="closeModal()">‡¶¨‡¶®‡ßç‡¶ß</button>
      </div>
    </div>
  </div>

  <!-- Add Baki Modal -->
  <div id="addBakiModal" class="modal">
    <div class="modal-content">
      <h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ï‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>

      <div class="row-2">
        <div>
          <label style="font-size:12px;color:#64748b;font-weight:900;">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
          <input type="date" id="addDate">
        </div>
        <div>
          <label style="font-size:12px;color:#64748b;font-weight:900;">‡¶™‡¶æ‡¶∞‡¶∏‡ßã‡¶®:</label>
          <select id="addPerson">
            <option value="">Select Person</option>
          </select>
        </div>
      </div>

      <label style="font-size:12px;color:#64748b;font-weight:900;">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
      <input type="text" id="addShop" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">

      <!-- ‚úÖ NEW: Description -->
      <label style="font-size:12px;color:#64748b;font-weight:900;">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</label>
      <input type="text" id="addDesc" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)">

      <label style="font-size:12px;color:#64748b;font-weight:900;">‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶®:</label>
      <input type="number" id="addAmount" placeholder="0.00">

      <div class="modal-btns">
        <button class="save-btn" onclick="saveManualBaki()">‡¶∏‡ßá‡¶≠</button>
        <button class="close-btn" onclick="closeAddBakiModal()">‡¶¨‡¶®‡ßç‡¶ß</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { database } from './firebase-config.js';
    import { ref, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    let activeTransactionKey = null;
    let activeDueIndex = null;
    let activeAmt = 0;
    let activePaid = 0;
    let activePerson = "";
    let activeShop = "";

    // ‚úÖ NEW: for showing last collection date+amount + prevent over-collection
    let activePayHistory = [];
    let activeDueNow = 0;

    // Store rows
    let renderedItems = [];
    let filteredItems = [];
    let currentPage = 1;
    let pageSize = 10;

    // ‚úÖ FIX: persons list store (Firebase persons path)
    let personsMaster = [];
    let personsLoaded = false;
    let transactionsLoaded = false;

    // Loading show/hide
    function showLoading(){
      const el = document.getElementById('loadingLayer');
      if (el) el.style.display = 'flex';
    }
    function hideLoading(){
      const el = document.getElementById('loadingLayer');
      if (el) el.style.display = 'none';
    }
    function tryHideLoading(){
      if (personsLoaded && transactionsLoaded) hideLoading();
    }

    // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á
    showLoading();

    // Sidebar Toggle
    window.toggleSidebar = (e) => {
      e.stopPropagation();
      const sb = document.getElementById('sidebar');
      const ov = document.getElementById('sidebarOverlay');
      sb.classList.toggle('open');
      if (sb.classList.contains('open')) ov.classList.add('show');
      else ov.classList.remove('show');
    };

    window.closeSidebarFromOverlay = () => {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('show');
    };

    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const menuIcon = document.querySelector('.menu-icon');
      if (!sidebar.contains(e.target) && e.target !== menuIcon) {
        sidebar.classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('show');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') window.closeSidebarFromOverlay();
    });

    // Date range panel toggle
    window.toggleRangePanel = () => {
      document.getElementById('rangePanel').classList.toggle('open');
    };

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    /* =========================================
       ‚úÖ FIX: Load Persons from `persons` node
       ========================================= */
    const personsRef = ref(database, 'persons');
    onValue(personsRef, (snapshot) => {
      const set = new Set();

      snapshot.forEach((ch) => {
        const v = ch.val();

        let name = "";
        if (typeof v === "string") name = v;
        else if (v && typeof v === "object") {
          name = v.name || v.personName || v.person || v.title || "";
        }

        name = String(name || "").trim();
        if (name) set.add(name);
      });

      personsMaster = [...set].sort();
      fillPersonDropdown(personsMaster);
      fillFilterPersonDropdown(personsMaster);

      personsLoaded = true;
      tryHideLoading();
    });

    // ‚úÖ CHANGE: This page now reads ONLY from `bakiTransactions`
    const bakiRef = ref(database, 'bakiTransactions');
    onValue(bakiRef, (snapshot) => {
      // ‚úÖ fallback set (‡¶Ø‡¶¶‡¶ø personsMaster ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
      const personFallbackSet = new Set();

      const transList = [];
      snapshot.forEach((childSnapshot) => {
        const v = childSnapshot.val();
        transList.push({ key: childSnapshot.key, val: v });

        if (v && v.personName) {
          const nm = String(v.personName).trim();
          if (nm) personFallbackSet.add(nm);
        }
      });

      // ‚úÖ If persons node empty, use transactions derived person list
      if (!personsMaster || personsMaster.length === 0) {
        const personsFallback = [...personFallbackSet].sort();
        fillPersonDropdown(personsFallback);
        fillFilterPersonDropdown(personsFallback);
      }

      // Latest first
      transList.reverse();

      const seenTxn = new Set();
      renderedItems = [];

      transList.forEach((item) => {
        const transKey = item.key;
        const trans = item.val;

        if (trans && trans.dues && Array.isArray(trans.dues)) {
          trans.dues.forEach((due, index) => {
            const dateStr = trans.date || "";
            const personName = trans.personName || "";
            const shopName = (due && due.shop) ? String(due.shop) : "";
            const amtStr = (due && due.amt != null) ? String(due.amt) : "0";
            const uniqueKey = `${dateStr}||${personName}||${shopName}||${amtStr}`;

            if (seenTxn.has(uniqueKey)) return;
            seenTxn.add(uniqueKey);

            const totalBaki = parseFloat(due.amt) || 0;

            // ‚úÖ paidAmt legacy + payHistory support
            const paidLegacy = parseFloat(due.paidAmt) || 0;
            const payHistory = Array.isArray(due.payHistory) ? due.payHistory : [];
            const paidFromHistory = payHistory.reduce((s, r) => s + (parseFloat(r?.amount) || 0), 0);
            const paid = Math.max(paidLegacy, paidFromHistory);

            const balanceRaw = totalBaki - paid;
            const balance = balanceRaw <= 0 ? 0 : balanceRaw;

            const status = balance <= 0 ? "Complete" : "Pending";

            renderedItems.push({
              transKey,
              dueIndex: index,
              date: dateStr,
              person: personName,
              shop: shopName,
              desc: (due && due.desc) ? String(due.desc) : "",
              total: totalBaki,
              paid,
              balance,
              status
            });
          });
        }
      });

      applyFilters(true);

      transactionsLoaded = true;
      tryHideLoading();
    });

    function fillPersonDropdown(persons) {
      const sel = document.getElementById('addPerson');
      const current = sel.value;
      sel.innerHTML = `<option value="">Select Person</option>`;
      persons.forEach((p) => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      });
      if (persons.includes(current)) sel.value = current;
    }

    function fillFilterPersonDropdown(persons) {
      const sel = document.getElementById('filterPerson');
      const current = sel.value;

      sel.innerHTML = `<option value="">‡¶∏‡¶¨</option>`;
      persons.forEach((p) => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      });

      if (persons.includes(current)) sel.value = current;
    }

    // Apply filters
    window.applyFilters = (resetPage = false) => {
      if (resetPage) currentPage = 1;

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const filterPerson = document.getElementById('filterPerson').value;
      const filterStatus = document.getElementById('filterStatus').value;

      const rangeToggle = document.getElementById('rangeToggle');
      if (startDate || endDate) {
        const s = startDate ? formatDate(startDate) : "--";
        const e = endDate ? formatDate(endDate) : "--";
        rangeToggle.value = `${s} ‡¶•‡ßá‡¶ï‡ßá ${e}`;
      } else {
        rangeToggle.value = "‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
      }

      filteredItems = [];
      let totalDueSum = 0;

      renderedItems.forEach((it) => {
        if (startDate && it.date && it.date < startDate) return;
        if (endDate && it.date && it.date > endDate) return;

        if (filterPerson && it.person !== filterPerson) return;

        if (filterStatus === "complete" && it.status !== "Complete") return;
        if (filterStatus === "pending" && it.status !== "Pending") return;

        filteredItems.push(it);
        totalDueSum += (parseFloat(it.balance) || 0);
      });

      document.getElementById('totalDue').innerText = `‡ß≥${totalDueSum.toFixed(2)}`;

      renderPage();
      renderPager();
    };

    function renderPage() {
      const tbody = document.getElementById('bakiTableBody');
      tbody.innerHTML = "";

      const totalPages = Math.max(1, Math.ceil(filteredItems.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;

      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = startIdx + pageSize;

      const pageItems = filteredItems.slice(startIdx, endIdx);

      let count = startIdx + 1;

      pageItems.forEach((it) => {
        const statusClass = it.status === "Complete" ? "completed" : "pending";

        tbody.innerHTML += `
          <tr>
            <td class="col-no">${count++}</td>
            <td class="col-date">${formatDate(it.date)}</td>
            <td class="col-person">${it.person || "-"}</td>
            <td class="col-shop">${it.shop || "-"}</td>
            <td class="col-desc">${escapeHTML(it.desc || "-")}</td>
            <td class="col-baki">‡ß≥${it.total.toFixed(2)}</td>
            <td class="col-paid">‡ß≥${it.paid.toFixed(2)}</td>
            <td class="col-due">‡ß≥${it.balance.toFixed(2)}</td>
            <td><span class="status-badge ${statusClass}">${it.status}</span></td>
            <td>
              <button class="action-btn" onclick="openPaymentModal('${it.transKey}', ${it.dueIndex}, '${escapeQuotes(it.person || "")}', '${escapeQuotes(it.shop || "")}', ${it.total}, ${it.paid})">
                <i class="fas fa-hand-holding-usd"></i> ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®
              </button>

              <button class="delete-btn" onclick="deleteBakiItem('${it.transKey}', ${it.dueIndex})">
                <i class="fas fa-trash"></i> Delete
              </button>
            </td>
          </tr>
        `;
      });
    }

    function renderPager() {
      const pager = document.getElementById('pager');
      pager.innerHTML = "";

      const totalPages = Math.max(1, Math.ceil(filteredItems.length / pageSize));

      const prevBtn = makeBtn("<<", () => gotoPage(currentPage - 1), currentPage === 1);
      pager.appendChild(prevBtn);

      const maxShow = 5;
      const showUntil = Math.min(maxShow, totalPages);

      for (let p = 1; p <= showUntil; p++) {
        pager.appendChild(makePageBtn(p));
      }

      if (totalPages > maxShow + 1) {
        const ell = document.createElement('span');
        ell.className = "page-ellipsis";
        ell.textContent = "...";
        pager.appendChild(ell);

        pager.appendChild(makePageBtn(totalPages));
      } else if (totalPages === maxShow + 1) {
        pager.appendChild(makePageBtn(totalPages));
      }

      const nextBtn = makeBtn(">>", () => gotoPage(currentPage + 1), currentPage === totalPages);
      pager.appendChild(nextBtn);
    }

    function makeBtn(text, onClick, disabled) {
      const btn = document.createElement('div');
      btn.className = "page-btn" + (disabled ? " disabled" : "");
      btn.textContent = text;
      if (!disabled) btn.onclick = onClick;
      return btn;
    }

    function makePageBtn(pageNum) {
      const btn = document.createElement('div');
      btn.className = "page-btn" + (pageNum === currentPage ? " active" : "");
      btn.textContent = String(pageNum);
      btn.onclick = () => gotoPage(pageNum);
      return btn;
    }

    window.gotoPage = (p) => {
      const totalPages = Math.max(1, Math.ceil(filteredItems.length / pageSize));
      if (p < 1 || p > totalPages) return;
      currentPage = p;
      renderPage();
      renderPager();
    };

    window.changePageSize = () => {
      const val = parseInt(document.getElementById('pageSizeSelect').value, 10) || 10;
      pageSize = val;
      currentPage = 1;
      renderPage();
      renderPager();
    };

    // Add Baki Modal handlers
    window.openAddBakiModal = () => {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('addDate').value = `${yyyy}-${mm}-${dd}`;

      document.getElementById('addPerson').value = "";
      document.getElementById('addShop').value = "";
      document.getElementById('addDesc').value = "";
      document.getElementById('addAmount').value = "";
      document.getElementById('addBakiModal').style.display = 'flex';
    };

    window.closeAddBakiModal = () => {
      document.getElementById('addBakiModal').style.display = 'none';
    };

    window.saveManualBaki = async () => {
      const date = document.getElementById('addDate').value;
      const person = document.getElementById('addPerson').value;
      const shop = document.getElementById('addShop').value.trim();
      const desc = document.getElementById('addDesc').value.trim();
      const amt = parseFloat(document.getElementById('addAmount').value) || 0;

      if (!date) return alert("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®");
      if (!person) return alert("‡¶™‡¶æ‡¶∞‡¶∏‡ßã‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®");
      if (!shop) return alert("‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");
      if (amt <= 0) return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");

      const newTrans = {
        date: date,
        personName: person,
        dues: [{ shop: shop, desc: desc, amt: amt, paidAmt: 0, payHistory: [] }]
      };

      // ‚úÖ CHANGE: save ONLY in bakiTransactions (not in transactions)
      push(ref(database, 'bakiTransactions'), newTrans).then(() => {
        closeAddBakiModal();
        alert("‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ï‡ßÄ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
      });
    };

    // Collection Modal handlers
    window.openPaymentModal = (key, index, personName, shopName, amt, paidAmt) => {
      activeTransactionKey = key;
      activeDueIndex = index;

      activeAmt = parseFloat(amt) || 0;
      activePaid = parseFloat(paidAmt) || 0;

      activePerson = personName || "";
      activeShop = shopName || "";

      const currentDue = Math.max(activeAmt - activePaid, 0);
      activeDueNow = currentDue;

      document.getElementById('modalInfo').innerText =
        (activePerson ? activePerson + " | " : "") +
        (activeShop ? activeShop : "") +
        " (‡¶™‡¶æ‡¶ì‡¶®‡¶æ: ‡ß≥" + currentDue.toFixed(2) + ")";

      // ‚úÖ show last collection (date + amount)
      document.getElementById('lastCollectionInfo').innerText = "";

      // ‚úÖ get latest payHistory from firebase once (no UI change)
      onValue(ref(database, `bakiTransactions/${activeTransactionKey}`), (snapshot) => {
        const data = snapshot.val();
        const due = (data && Array.isArray(data.dues)) ? data.dues[activeDueIndex] : null;
        const payHistory = (due && Array.isArray(due.payHistory)) ? due.payHistory : [];
        activePayHistory = payHistory;

        if (payHistory.length > 0){
          const last = payHistory[payHistory.length - 1];
          const dt = last?.date || "-";
          const am = parseFloat(last?.amount) || 0;
          document.getElementById('lastCollectionInfo').innerText = `‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ú‡¶Æ‡¶æ: ${formatDate(dt)} | ‡ß≥${am.toFixed(2)}`;
        }else{
          document.getElementById('lastCollectionInfo').innerText = `‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ú‡¶Æ‡¶æ: ‡¶®‡ßá‡¶á`;
        }
      }, { onlyOnce: true });

      document.getElementById('collectionInput').value = "";
      document.getElementById('paymentModal').style.display = 'flex';
    };

    window.closeModal = () => {
      document.getElementById('paymentModal').style.display = 'none';
    };

    window.processCollection = async () => {
      const amount = parseFloat(document.getElementById('collectionInput').value) || 0;
      if (amount <= 0) return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶Ö‡¶Ç‡¶ï ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");

      // ‚úÖ Prevent saving if already complete
      if (activeDueNow <= 0) {
        return alert("‡¶è‡¶ü‡¶æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá Complete ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶Ü‡¶∞ ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§");
      }

      // ‚úÖ Prevent over payment
      if (amount > activeDueNow) {
        return alert(`‡¶™‡¶æ‡¶ì‡¶®‡¶æ ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡ß≥${activeDueNow.toFixed(2)}‡•§ ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§`);
      }

      // ‚úÖ CHANGE: update ONLY from bakiTransactions node
      onValue(ref(database, `bakiTransactions/${activeTransactionKey}`), (snapshot) => {
        const data = snapshot.val();
        if (data && data.dues && Array.isArray(data.dues) && data.dues[activeDueIndex]) {
          const dues = [...data.dues];

          const currentPaid = parseFloat(dues[activeDueIndex].paidAmt) || 0;
          const totalAmt = parseFloat(dues[activeDueIndex].amt) || 0;
          const currentDueNow = Math.max(totalAmt - currentPaid, 0);

          // ‚úÖ prevent saving when complete (re-check fresh data)
          if (currentDueNow <= 0) {
            closeModal();
            return alert("‡¶è‡¶ü‡¶æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá Complete ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶Ü‡¶∞ ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§");
          }

          // ‚úÖ prevent over pay (fresh check)
          if (amount > currentDueNow) {
            return alert(`‡¶™‡¶æ‡¶ì‡¶®‡¶æ ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡ß≥${currentDueNow.toFixed(2)}‡•§ ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§`);
          }

          // ‚úÖ add payHistory item with date + amount
          const payHistory = Array.isArray(dues[activeDueIndex].payHistory) ? [...dues[activeDueIndex].payHistory] : [];
          const entry = { date: todayISO(), amount: amount };
          payHistory.push(entry);

          dues[activeDueIndex].payHistory = payHistory;

          // ‚úÖ keep paidAmt also updated (for compatibility)
          dues[activeDueIndex].paidAmt = currentPaid + amount;

          update(ref(database, `bakiTransactions/${activeTransactionKey}`), {
            dues: dues
          }).then(() => {
            // ‚úÖ show in form immediately: date + amount
            document.getElementById('lastCollectionInfo').innerText =
              `‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ú‡¶Æ‡¶æ: ${formatDate(entry.date)} | ‡ß≥${amount.toFixed(2)}`;

            closeModal();
            alert("‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
          });
        }
      }, { onlyOnce: true });
    };

    // ‚úÖ NEW: Delete function (deletes single due item; if last due then deletes transaction)
    window.deleteBakiItem = async (transKey, dueIndex) => {
      const ok = confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?");
      if (!ok) return;

      onValue(ref(database, `bakiTransactions/${transKey}`), async (snapshot) => {
        const data = snapshot.val();
        if (!data || !Array.isArray(data.dues)) return alert("‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");

        const dues = [...data.dues];
        if (!dues[dueIndex]) return alert("‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");

        dues.splice(dueIndex, 1);

        if (dues.length === 0) {
          // remove whole transaction if no dues left
          await remove(ref(database, `bakiTransactions/${transKey}`));
        } else {
          await update(ref(database, `bakiTransactions/${transKey}`), { dues });
        }

        alert("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
      }, { onlyOnce: true });
    };

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const parts = dateStr.split('-');
      if (parts.length !== 3) return dateStr;
      const [y, m, d] = parts;
      return `${d}-${m}-${y}`;
    }

    function escapeQuotes(str) {
      return String(str).replace(/'/g, "\\'");
    }

    // ‚úÖ NEW: safe html escape for description cell
    function escapeHTML(str){
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
