<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy & Sell - Hisab</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;

      --brand:#2563eb;
      --brand2:#60a5fa;

      --good:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;

      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 2px 10px rgba(15,23,42,.08);

      --r12:12px;
      --r16:16px;
      --r18:18px;

      --topbar-h: 106px;
      --sb-w: 295px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(16,185,129,.06), transparent 55%),
        var(--bg);
      padding-top: var(--topbar-h);
      color: var(--text);
    }

    .page-loader{
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      transition: .22s ease;
    }
    .page-loader.hide{ opacity:0; pointer-events:none; }
    .loader-card{
      width: min(420px, 92vw);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 18px;
      box-shadow: 0 30px 120px rgba(15,23,42,.18);
      padding: 18px 16px;
      text-align: center;
    }
    .loader-title{ font-weight: 1000; font-size: 15px; color:#0f172a; margin: 10px 0 4px 0; }
    .loader-sub{ font-weight: 900; font-size: 12px; color: var(--muted); margin: 0; }
    .spinner{
      width: 54px; height: 54px; border-radius: 999px;
      border: 6px solid rgba(37,99,235,.18);
      border-top-color: rgba(37,99,235,1);
      margin: 4px auto 10px auto;
      animation: spin .9s linear infinite;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    .navbar{
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229,231,235,.9);
      box-shadow: 0 8px 30px rgba(15,23,42,.06);
      padding: 10px 14px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 10;
    }
    .nav-top{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 10px; gap: 10px;
    }
    .menu-icon{
      width:42px; height:42px;
      display:grid; place-items:center;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(37,99,235,.12), rgba(37,99,235,.06));
      color: var(--brand);
      font-size: 20px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .navbar h1{
      font-size: 18px; margin:0; font-weight: 900;
      flex-grow:1; text-align:center; letter-spacing: .2px; color:#0f172a;
    }
    .nav-buttons{ display:flex; gap:10px; justify-content:center; }
    .btn{
      padding: 10px 14px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 900;
      color: white;
      display:flex;
      align-items:center;
      gap: 8px;
      box-shadow: var(--shadow2);
      transition: .15s;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(.99); }
    .btn-person{ background: linear-gradient(135deg, rgba(37,99,235,1), rgba(96,165,250,1)); }
    .btn-delivery{ background: linear-gradient(135deg, rgba(22,163,74,1), rgba(34,197,94,1)); }

    .sidebar-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      z-index: 80;
      opacity:0; pointer-events:none;
      transition:.2s;
    }
    .sidebar-overlay.show{ opacity:1; pointer-events:auto; }

    .sidebar{
      position: fixed; top: 0; left: 0;
      width: var(--sb-w); height: 100%;
      transform: translateX(-110%);
      transition: .28s ease;
      z-index: 90;
      background: linear-gradient(180deg, #0b1224 0%, #0f172a 45%, #0b1224 100%);
      box-shadow: 0 30px 80px rgba(0,0,0,.28);
      padding: 14px 14px 18px 14px;
      overflow: auto;
    }
    .sidebar.open{ transform: translateX(0); }

    .sb-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding: 8px 4px 12px 4px; }
    .sb-title{ color:#fff; font-weight:1000; font-size:20px; line-height:1.1; margin:2px 0 0 0; }
    .sb-sub{ color:rgba(255,255,255,.65); font-weight:800; font-size:12px; margin-top:4px; }
    .sb-close{
      width:44px; height:44px;
      border:none; border-radius: 16px;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      color:#fff;
      display:grid; place-items:center;
      font-size:18px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .sb-close:active{ transform: scale(.98); }
    .sb-divider{ height:1px; background: rgba(255,255,255,.08); margin: 10px 0 14px 0; }
    .sb-links{ display:flex; flex-direction:column; gap:12px; }
    .sidebar a{
      display:flex; align-items:center; gap:12px;
      padding: 14px 14px;
      border-radius: 16px;
      color: rgba(255,255,255,.92);
      text-decoration:none;
      font-weight: 1000;
      font-size: 15px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      transition:.18s;
      margin:0;
    }
    .sidebar a:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }
    .sb-ic{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 16px;
      flex: 0 0 auto;
    }

    .main-container{ padding: 10px; max-width: 1100px; margin: 0 auto; }

    .filter-wrapper{
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(229,231,235,.9);
      box-shadow: var(--shadow);
      padding: 14px;
      border-radius: var(--r18);
      margin-bottom: 14px;
    }
    .filter-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      align-items: end;
    }

    label{ font-size: 12px; font-weight: 900; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select{
      width: 100%;
      padding: 10px 12px;
      margin: 0;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      font-size: 13px;
      font-weight: 800;
      outline:none;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .date-range-box{
      display:flex; gap:8px;
      background: linear-gradient(180deg, rgba(37,99,235,.05), rgba(37,99,235,.02));
      padding:10px; border-radius: 16px;
      border: 1px solid rgba(37,99,235,.18);
    }
    .date-range-box input{ border: 1px solid rgba(229,231,235,.9); border-radius: 14px; padding: 10px 10px; font-size:12px; }

    .profit-box{
      background: linear-gradient(135deg, rgba(22,163,74,1), rgba(34,197,94,1));
      color:#fff; padding:12px; border-radius: 18px;
      text-align:center; font-weight: 1000;
      box-shadow: var(--shadow2);
    }
    #displayTotalProfit{ font-size:16px; }

    .history-card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(229,231,235,.9);
      padding: 14px;
      border-radius: var(--r18);
      box-shadow: var(--shadow);
      margin-top: 14px;
      overflow: hidden;
    }
    .history-card h3{ margin:0 0 10px 0; font-size:15px; font-weight:1000; color:#0f172a; }

    .table-container{
      width: 100%;
      overflow-x: auto;
      margin-top: 10px;
      background: #fff;
      border-radius: 16px;
      border: 1px solid rgba(229,231,235,.9);
    }
    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      white-space: nowrap;
    }
    table th, table td{
      border-bottom: 1px solid rgba(229,231,235,.8);
      padding: 12px 10px;
      text-align: center;
    }
    table th{
      background: linear-gradient(180deg, #0f172a, #111827);
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 12px;
      font-weight: 1000;
      border-bottom: 1px solid rgba(0,0,0,.2);
    }
    tbody tr:hover{ background: rgba(37,99,235,.05); }

    .col-no{ background-color: #f1f5f9; font-weight: 1000; }
    .col-date{ background-color: #fff7ed; }
    .col-name{ background-color: #eff6ff; font-weight: 900; }

    /* ‚úÖ updated meaning */
    .col-outpcs{ background-color:#ffffff; color:#0f172a; font-weight:1000; }
    .col-sellpcs{ background-color:#ffffff; color:#087f5b; font-weight:1000; }
    .col-sellamt{ background-color:#ffffff; color:#d9480f; font-weight:1000; }
    .col-cash{ background-color: #f0fdf4; color: #166534; font-weight: 1000; }

    .action-btn{
      padding: 8px 10px; border: none; border-radius: 12px;
      cursor:pointer; color:#fff; margin:2px;
      font-weight: 900; font-size: 12px;
      box-shadow: var(--shadow2);
      transition:.15s;
    }
    .action-btn:active{ transform: scale(.99); }
    .btn-edit-row{ background: linear-gradient(135deg, rgba(37,99,235,1), rgba(96,165,250,1)); }
    .btn-pay-row{ background: linear-gradient(135deg, rgba(124,58,237,1), rgba(168,85,247,1)); }
    .btn-del-row{ background: linear-gradient(135deg, rgba(239,68,68,1), rgba(244,63,94,1)); }

    .modal{
      display:none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,.60);
      z-index: 100;
      justify-content:center;
      align-items:center;
      padding: 16px;
    }
    .modal-content{
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(229,231,235,.9);
      padding: 16px;
      border-radius: 18px;
      width: 98%;
      max-width: 1100px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 40px 120px rgba(0,0,0,.25);
    }
    .modal-content h3{ margin:0 0 10px 0; font-size:15px; font-weight:1000; color:#0f172a; }

    .form-box{
      background: linear-gradient(180deg, rgba(15,23,42,.03), rgba(15,23,42,.01));
      border: 1px solid rgba(229,231,235,.9);
      padding: 14px;
      border-radius: 16px;
      margin-bottom: 14px;
    }
    .form-title{
      font-size: 13px; font-weight:1000;
      color:#0f172a;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(229,231,235,.9);
      padding-bottom: 8px;
    }

    #mainPersonSelect option:nth-child(even){ background-color: #f2f2f2; }
    #mainPersonSelect option:nth-child(odd){ background-color: #ffffff; }

    .save-btn{
      background: linear-gradient(135deg, rgba(15,23,42,1), rgba(31,41,55,1));
      color: white;
      border:none;
      padding: 12px;
      width: 100%;
      border-radius: 16px;
      font-weight: 1000;
      cursor:pointer;
      margin-top: 16px;
      box-shadow: var(--shadow2);
    }
    .cancel-btn{
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(244,63,94,1));
      color: white;
      border:none;
      padding: 12px;
      width: 100%;
      border-radius: 16px;
      font-weight: 1000;
      cursor:pointer;
      margin-top: 10px;
      box-shadow: var(--shadow2);
    }
    .ok-btn{
      background: linear-gradient(135deg, rgba(245,158,11,1), rgba(251,191,36,1));
      color: #111827;
      border:none;
      padding: 12px;
      width: 100%;
      border-radius: 16px;
      font-weight: 1000;
      cursor:pointer;
      margin-top: 10px;
      box-shadow: var(--shadow2);
    }
    .close-link{
      display:block;
      text-align:center;
      margin-top: 12px;
      color: var(--muted);
      cursor:pointer;
      text-decoration: underline;
      font-size: 13px;
      font-weight: 800;
    }

    .pagination-bar{
      padding: 12px 10px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 16px;
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap: 10px;
      box-shadow: 0 2px 10px rgba(15,23,42,.06);
    }
    .pager{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .page-btn{
      border: 1px solid rgba(229,231,235,.9);
      background: linear-gradient(180deg, rgba(15,23,42,.04), rgba(15,23,42,.02));
      color: #0f172a;
      padding: 8px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 1000;
      min-width: 42px;
      text-align:center;
      transition:.15s;
      user-select:none;
    }
    .page-btn:hover{ transform: translateY(-1px); }
    .page-btn.active{
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(96,165,250,1));
      border-color: rgba(37,99,235,.6);
      color:#fff;
    }
    .page-btn.disabled{ opacity:.5; cursor:not-allowed; transform:none; }
    .page-ellipsis{ padding: 8px 6px; color: var(--muted); font-weight: 1000; }
    .page-size{ margin-left:auto; display:flex; align-items:center; gap: 8px; }
    .page-size select{
      padding: 8px 10px;
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 14px;
      font-size: 13px;
      background: #fff;
      font-weight: 900;
      width: 90px;
    }

    .due-item{
      background:#fff;
      padding:10px 10px;
      border:1px solid rgba(229,231,235,.9);
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      cursor:pointer;
      border-radius: 14px;
      font-weight: 900;
      color:#0f172a;
      box-shadow: 0 2px 10px rgba(15,23,42,.04);
    }
    .due-item:hover{ background: rgba(37,99,235,.04); }

    /* =========================
       ‚úÖ Delivery Table UI
       ========================= */
    .delivery-headline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .delivery-person{
      font-weight: 1000;
      color: #2563eb;
      font-size: 16px;
    }
    .delivery-meta{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .meta-box{
      display:flex;
      gap: 8px;
      align-items:center;
      padding: 8px 10px;
      background:#fff;
      border:1px solid rgba(229,231,235,.9);
      border-radius: 14px;
      font-weight: 900;
    }
    .meta-box label{
      margin:0;
      font-size: 12px;
      font-weight: 1000;
      color: var(--muted);
    }
    .meta-box input{
      width: 180px;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 900;
    }

    .delivery-table-wrap{
      width: 100%;
      overflow: auto;
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 16px;
      background: #fff;
    }

    /* ‚úÖ laptop delivery modal wider */
    #deliveryMainModal .modal-content{
      max-width: 1400px; /* ‚úÖ bigger on laptop */
      padding: 18px;
    }

    .delivery-table{
      width: 100%;
      border-collapse: collapse;
      min-width: 1250px; /* ‚úÖ content wider */
      font-size: 13px;
      white-space: nowrap;
    }
    .delivery-table th, .delivery-table td{
      border: 1px solid rgba(229,231,235,.95);
      padding: 12px 10px; /* ‚úÖ a bit bigger */
      text-align: center;
      vertical-align: middle;
      font-weight: 900;
    }
    .delivery-table thead th{
      background: linear-gradient(180deg, #0f172a, #111827);
      color:#fff;
      position: sticky;
      top: 0;
      z-index: 3;
      font-size: 12px;
      font-weight: 1000;
    }
    .delivery-table thead tr:nth-child(2) th{
      background: linear-gradient(180deg, #111827, #0f172a);
      z-index: 4;
      font-size: 11px;
      letter-spacing:.2px;
    }

    .pkg-cell{
      text-align:left !important;
      font-weight: 1000;
      background: #f8fafc;
      min-width: 340px; /* ‚úÖ more space */
    }
    .pkg-sub{
      display:block;
      font-size: 11px;
      font-weight: 900;
      color: rgba(15,23,42,.65);
      margin-top: 2px;
    }

    /* ‚úÖ input 0 faint */
    .qty-inp{
      width: 96px;
      padding: 11px 10px;
      border-radius: 12px;
      border: 1px solid rgba(229,231,235,.95);
      font-weight: 1000;
      font-size: 13px;
      outline: none;
      text-align: center;
      color: rgba(15,23,42,.92);
    }
    .qty-inp.is-zero{
      color: rgba(15,23,42,.22); /* ‚úÖ opacity ‡¶ï‡¶Æ */
    }
    .qty-inp:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .sellpcs-cell{ font-weight: 1000; color:#0f172a; }
    .money-cell{ font-weight: 1000; color:#ef4444; }

    .save-delivery-btn{
      margin-top: 12px;
      width: 100%;
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(96,165,250,1));
      color:#fff;
      border:none;
      padding: 12px 12px;
      border-radius: 16px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .save-delivery-btn:active{ transform: scale(.99); }

    @media (max-width:520px){
      .nav-buttons .btn{ flex:1; justify-content:center; }
      .navbar{ padding: 10px 12px; }
      #deliveryMainModal .modal-content{ max-width: 1100px; padding:16px; }
      .delivery-table{ min-width: 1100px; }
    }
</style>
</head>

<body>

<div id="pageLoader" class="page-loader">
  <div class="loader-card">
    <div class="spinner"></div>
    <div class="loader-title">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    <p class="loader-sub">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
  </div>
</div>

<div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebarFromOverlay()"></div>

<div class="navbar">
  <div class="nav-top">
    <span class="menu-icon" onclick="toggleSidebar(event)">‚ò∞</span>
    <h1>Buy & Sell</h1>
    <div style="width:22px"></div>
  </div>
  <div class="nav-buttons">
    <button class="btn btn-person" onclick="openModal('personModal')"><i class="fas fa-user-plus"></i> Person</button>
    <button class="btn btn-delivery" onclick="openModal('deliverySelectModal')">üöö Delivery</button>
  </div>
</div>

<div id="sidebar" class="sidebar">
  <div class="sb-head">
    <div>
      <div class="sb-title">Today Hisab</div>
      <div class="sb-sub">‡¶Æ‡ßá‡¶®‡ßÅ</div>
    </div>
    <button class="sb-close" onclick="closeSidebarFromOverlay()" aria-label="Close">‚úï</button>
  </div>
  <div class="sb-divider"></div>

  <div class="sb-links">
    <a href="index.html"><span class="sb-ic">üè†</span> Dashboard</a>
    <a href="hisab.html"><span class="sb-ic">üßæ</span> ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</a>
    <a href="stock.html"><span class="sb-ic">üì¶</span> ‡¶Æ‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ï</a>
    <a href="today.html"><span class="sb-ic">üìÖ</span> ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßá‡¶≤</a>
    <a href="baki.html"><span class="sb-ic">üßç</span> ‡¶¨‡¶æ‡¶ï‡ßÄ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</a>
  </div>
</div>

<div class="main-container">
  <div class="filter-wrapper">
    <div class="filter-grid">
      <div>
        <label><i class="fas fa-calendar-alt"></i> ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ (‡¶∂‡ßÅ‡¶∞‡ßÅ - ‡¶∂‡ßá‡¶∑):</label>
        <div class="date-range-box">
          <input type="date" id="filterStartDate" onchange="applyFilters()">
          <input type="date" id="filterEndDate" onchange="applyFilters()">
        </div>
      </div>
      <div>
        <label><i class="fas fa-user"></i> ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <select id="filterPerson" onchange="applyFilters()"></select>
      </div>
      <div class="profit-box">
        <div style="font-size: 12px; opacity: 0.9;">‡¶Æ‡ßã‡¶ü ‡¶≤‡¶æ‡¶≠</div>
        <span id="displayTotalProfit">‡ß≥0</span>
      </div>
    </div>
  </div>

  <div class="history-card">
    <h3>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
            <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
            <th>‡¶®‡¶æ‡¶Æ</th>
            <th>‡¶¨‡¶π‡¶ø‡¶∞ ‡¶™‡¶£‡ßç‡¶Ø (‡¶™‡¶ø‡¶∏)</th>
            <th>‡¶∏‡ßá‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø (‡¶™‡¶ø‡¶∏)</th>
            <th>‡¶∏‡ßá‡¶≤ (‡¶ü‡¶æ‡¶ï‡¶æ)</th>
            <th>‡¶ú‡¶Æ‡¶æ (‡¶ü‡¶æ‡¶ï‡¶æ)</th>
            <th>‡¶è‡¶ï‡¶∂‡¶®</th>
          </tr>
        </thead>
        <tbody id="historyTableBody"></tbody>
      </table>
    </div>

    <div class="pagination-bar">
      <div class="pager" id="pager"></div>
      <div class="page-size">
        <select id="pageSizeSelect" onchange="changePageSize()">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="15">15</option>
          <option value="20">20</option>
        </select>
      </div>
    </div>
  </div>
</div>

<div id="deliverySelectModal" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <h3>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ó‡ßç‡¶∞‡¶π‡ßÄ‡¶§‡¶æ</h3>
    <select id="mainPersonSelect"></select>
    <button class="save-btn" onclick="startDelivery()">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
    <button class="cancel-btn" onclick="closeModal('deliverySelectModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
  </div>
</div>

<div id="deliveryMainModal" class="modal">
  <div class="modal-content">
    <div class="delivery-headline">
      <div id="displaySelectedPerson" class="delivery-person"></div>
      <div class="delivery-meta">
        <div class="meta-box">
          <label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
          <input type="date" id="deliveryDate">
        </div>
      </div>
    </div>

    <div class="form-box">
      <div class="form-title">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø / ‡¶´‡ßá‡¶∞‡¶§ (‡¶ü‡ßá‡¶¨‡¶ø‡¶≤)</div>

      <div class="delivery-table-wrap">
        <table class="delivery-table">
          <thead>
            <tr>
              <th rowspan="2" style="text-align:left;">‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
              <th colspan="2">‡¶¨‡¶π‡¶ø‡¶∞ ‡¶™‡¶£‡ßç‡¶Ø</th>
              <th colspan="2">‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶£‡ßç‡¶Ø</th>
              <th rowspan="2">‡¶∏‡ßá‡¶≤ ‡¶™‡¶ø‡¶∏</th>
              <th rowspan="2">‡¶ü‡¶æ‡¶ï‡¶æ</th>
            </tr>
            <tr>
              <th>‡¶ï‡ßá‡¶∏</th>
              <th>‡¶™‡¶ø‡¶∏</th>
              <th>‡¶ï‡ßá‡¶∏</th>
              <th>‡¶™‡¶ø‡¶∏</th>
            </tr>
          </thead>
          <tbody id="deliveryPkgTbody"></tbody>
        </table>
      </div>

      <button class="save-delivery-btn" onclick="saveDeliverySmart()">‚úÖ Save</button>
    </div>

    <span class="close-link" onclick="closeModal('deliveryMainModal')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</span>
  </div>
</div>

<div id="paymentModal" class="modal">
  <div class="modal-content" style="max-width: 450px;">
    <h3 id="paymentTitle">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
    <div class="form-box">
      <label>‡¶®‡¶ó‡¶¶ ‡¶ú‡¶Æ‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ:</label>
      <input class="qty-inp" type="number" id="cashReceivedInput" value="0">
    </div>

    <div class="form-box" style="background: rgba(245,158,11,.08); border-color: rgba(245,158,11,.25);">
      <div class="form-title">‡¶¨‡¶æ‡¶ï‡ßÄ (‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï)</div>
      <input type="text" id="dueShopName" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
      <input class="qty-inp" type="number" id="dueAmount" value="0">
      <button class="ok-btn" style="background: linear-gradient(135deg, rgba(15,23,42,1), rgba(31,41,55,1)); color:#fff;" onclick="addDueToList()">‡¶¨‡¶æ‡¶ï‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      <div id="dueListContainer"></div>
    </div>

    <button class="save-btn" onclick="savePaymentData()">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <span class="close-link" onclick="closeModal('paymentModal')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</span>
  </div>
</div>

<div id="personModal" class="modal">
  <div class="modal-content">
    <h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡ßã‡¶ï</h3>
    <input type="text" id="personName" placeholder="‡¶®‡¶æ‡¶Æ">
    <button class="save-btn" onclick="savePerson()">Save</button>
    <span class="close-link" onclick="closeModal('personModal')">‡¶¨‡¶®‡ßç‡¶ß</span>
  </div>
</div>

<script type="module">
  import { database } from './firebase-config.js';
  import { ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  let packages = {};
  let currentDues = [];
  let selectedPersonName = "";
  let activePaymentGroupKey = null;
  let allTransactions = [];

  let deliveryRows = [];
  let currentCashData = 0;
  let currentDuesData = [];
  let currentEditingGroupKey = null;

  let currentPage = 1;
  let pageSize = 10;
  let lastSortedKeys = [];

  let editingDueIndex = null;

  const formatDate = (dateStr) => {
    if(!dateStr) return "";
    const [y, m, d] = dateStr.split('-');
    return `${d}-${m}-${y}`;
  };

  const todayISO = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  };

  const safeNum = (v) => {
    const n = parseInt(v, 10);
    return isNaN(n) ? 0 : n;
  };

  const pcsFromCasePcs = (cases, pcs, caseQty) => {
    const cq = parseInt(caseQty) || 1;
    return (safeNum(cases) * cq) + safeNum(pcs);
  };

  const splitToCasePcs = (totalPcs, caseQty) => {
    const cq = parseInt(caseQty) || 1;
    const t = safeNum(totalPcs);
    const c = cq ? Math.floor(t / cq) : 0;
    const p = cq ? (t % cq) : t;
    return { c, p };
  };

  /* =========================
     ‚úÖ Loading control
     ========================= */
  const loaderEl = document.getElementById('pageLoader');
  const hideLoader = () => {
    if (!loaderEl) return;
    loaderEl.classList.add('hide');
    setTimeout(() => { loaderEl.style.display = 'none'; }, 260);
  };

  const loadState = { persons:false, categories:false, packages:false, transactions:false };
  const checkAllLoaded = () => {
    if (loadState.persons && loadState.categories && loadState.packages && loadState.transactions) hideLoader();
  };

  // ‚úÖ Sidebar UI
  window.toggleSidebar = (e) => {
    e.stopPropagation();
    const sb = document.getElementById('sidebar');
    sb.classList.toggle('open');
    const ov = document.getElementById('sidebarOverlay');
    if (sb.classList.contains('open')) ov.classList.add('show');
    else ov.classList.remove('show');
  };
  window.closeSidebarFromOverlay = () => {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
  };
  document.addEventListener('click', (event) => {
    const sb = document.getElementById('sidebar');
    const menuIcon = document.querySelector('.menu-icon');
    if (!sb.contains(event.target) && event.target !== menuIcon) {
      sb.classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('show');
    }
  });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') window.closeSidebarFromOverlay(); });

  window.openModal = (id) => { document.getElementById(id).style.display = 'flex'; };
  window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; };

  /* =========================
     ‚úÖ Input zero behavior (NO SELECT + faint 0)
     ========================= */
  function setZeroClass(inp){
    const isZero = String(inp.value).trim() === "0";
    inp.classList.toggle('is-zero', isZero);
  }

  function bindZeroInput(inp){
    if (inp.dataset.zeroBound === "1") return;
    inp.dataset.zeroBound = "1";

    if (inp.value === "" || inp.value == null) inp.value = "0";
    setZeroClass(inp);

    // ‚úÖ focus: no select, just caret end
    inp.addEventListener('focus', () => {
      setZeroClass(inp);
      const len = inp.value.length;
      try { inp.setSelectionRange(len, len); } catch(e){}
    });

    // ‚úÖ if value is 0 and user presses digit => replace 0
    inp.addEventListener('keydown', (e) => {
      const v = String(inp.value).trim();
      if (v === "0" && /^[0-9]$/.test(e.key)) {
        inp.value = e.key;    // replace
        e.preventDefault();
        setZeroClass(inp);
        try { inp.setSelectionRange(inp.value.length, inp.value.length); } catch(e){}
      }
    });

    inp.addEventListener('input', () => {
      if (inp.value === "") return;
      setZeroClass(inp);
    });

    // ‚úÖ blur: empty ‡¶π‡¶≤‡ßá 0
    inp.addEventListener('blur', () => {
      if (inp.value === "" || inp.value == null) inp.value = "0";
      setZeroClass(inp);
    });
  }

  function attachZeroBehavior(){
    const nodes = document.querySelectorAll('input.qty-inp, #cashReceivedInput, #dueAmount');
    nodes.forEach(bindZeroInput);

    // delivery inputs (generated)
    document.querySelectorAll('#deliveryMainModal input.qty-inp').forEach(bindZeroInput);
  }

  // ‚úÖ Persons
  let personsFirstLoad = true;
  onValue(ref(database, 'persons'), (snapshot) => {
    let options = '<option value="">‡¶®‡¶æ‡¶Æ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</option>';
    snapshot.forEach(child => { options += `<option value="${child.val().name}">${child.val().name}</option>`; });
    document.getElementById('mainPersonSelect').innerHTML = options;
    document.getElementById('filterPerson').innerHTML = '<option value="">‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø</option>' + options;

    if (personsFirstLoad) {
      personsFirstLoad = false;
      loadState.persons = true;
      checkAllLoaded();
    }
  });

  // ‚úÖ Categories (loader only)
  let categoriesFirstLoad = true;
  onValue(ref(database, 'categories'), () => {
    if (categoriesFirstLoad) {
      categoriesFirstLoad = false;
      loadState.categories = true;
      checkAllLoaded();
    }
  });

  // ‚úÖ Packages
  let packagesFirstLoad = true;
  onValue(ref(database, 'packages'), (snapshot) => {
    packages = {};
    snapshot.forEach(child => { packages[child.key] = { ...child.val(), key: child.key }; });

    if (packagesFirstLoad) {
      packagesFirstLoad = false;
      loadState.packages = true;
      checkAllLoaded();
    }
  });

  // ‚úÖ Transactions
  let transactionsFirstLoad = true;
  onValue(ref(database, 'transactions'), (snapshot) => {
    allTransactions = [];
    snapshot.forEach(child => { allTransactions.push({key: child.key, ...child.val()}); });
    applyFilters();

    if (transactionsFirstLoad) {
      transactionsFirstLoad = false;
      loadState.transactions = true;
      checkAllLoaded();
    }
  });

  window.applyFilters = () => {
    currentPage = 1;

    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const filterPerson = document.getElementById('filterPerson').value;

    const filtered = allTransactions.filter(t => {
      const dateMatch = (!startDate || t.date >= startDate) && (!endDate || t.date <= endDate);
      const personMatch = !filterPerson || t.personName === filterPerson;
      return dateMatch && personMatch;
    });

    const grouped = {};
    let totalProfit = 0;
    const hasFilter = startDate || endDate || filterPerson;

    filtered.forEach(t => {
      const dateKey = `${t.date}_${t.personName}`;
      if(!grouped[dateKey]) grouped[dateKey] = {
        date: t.date,
        name: t.personName,
        outPcs: 0,
        returnPcs: 0,
        sellPcs: 0,
        sellAmt: 0,
        cash: 0,
        items: [],
        lastKey: t.key || ""
      };

      // ‚úÖ track latest push key for sorting
      if ((t.key || "") > (grouped[dateKey].lastKey || "")) grouped[dateKey].lastKey = t.key || "";

      const type = t.type || "Out";
      const sellPrice = parseFloat(t.pkgSellPrice) || 0;
      const totalPcs = parseInt(t.totalPcs) || 0;

      if(hasFilter) {
        const pkgInfo = Object.values(packages).find(p => p.name === t.pkgName);
        if(pkgInfo) {
          const buyPrice = parseFloat(pkgInfo.buyPrice) || 0;
          const unitProfit = sellPrice - buyPrice;
          if(type === "Out") totalProfit += (unitProfit * totalPcs);
          else totalProfit -= (unitProfit * totalPcs);
        }
      }

      if(type === "Out") grouped[dateKey].outPcs += totalPcs;
      else grouped[dateKey].returnPcs += totalPcs;

      // ‚úÖ sell amount net
      const amt = totalPcs * sellPrice;
      if(type === "Out") grouped[dateKey].sellAmt += amt;
      else grouped[dateKey].sellAmt -= amt;

      grouped[dateKey].cash = (parseFloat(t.cashReceived) || 0);
      grouped[dateKey].items.push(t);
    });

    // compute sell pcs
    Object.keys(grouped).forEach(k => {
      grouped[k].sellPcs = Math.max(0, (grouped[k].outPcs || 0) - (grouped[k].returnPcs || 0));
    });

    document.getElementById('displayTotalProfit').innerText = hasFilter ? `‡ß≥${totalProfit.toFixed(2)}` : `‡ß≥0`;
    renderTable(grouped);
  };

  function renderTable(grouped) {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = "";

    // ‚úÖ newest group first by date + latest push key
    const sortedKeys = Object.keys(grouped).sort((a, b) => {
      const A = grouped[a], B = grouped[b];
      if (A.date !== B.date) return (B.date || "").localeCompare(A.date || "");
      return (B.lastKey || "").localeCompare(A.lastKey || "");
    });

    lastSortedKeys = sortedKeys;

    const total = sortedKeys.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const pageKeys = sortedKeys.slice(startIdx, endIdx);

    let count = startIdx + 1;

    pageKeys.forEach(dateKey => {
      const row = grouped[dateKey];
      tbody.innerHTML += `<tr>
        <td class="col-no">${count++}</td>
        <td class="col-date">${formatDate(row.date)}</td>
        <td class="col-name">${row.name}</td>

        <td class="col-outpcs">${row.outPcs}</td>
        <td class="col-sellpcs">${row.sellPcs}</td>
        <td class="col-sellamt">‡ß≥${(row.sellAmt || 0).toFixed(2)}</td>
        <td class="col-cash">‡ß≥${(row.cash || 0).toFixed(2)}</td>

        <td>
          <button class="action-btn btn-edit-row" onclick="reopenDeliveryForm('${dateKey}')"><i class="fas fa-file-invoice"></i> Form</button>
          <button class="action-btn btn-pay-row" onclick="openPaymentForm('${dateKey}')"><i class="fas fa-money-bill-wave"></i> ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
          <button class="action-btn btn-del-row" onclick="deleteTransactionGroup('${dateKey}')"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`;
    });

    window.groupedData = grouped;
    renderPager(totalPages);
  }

  window.changePageSize = () => {
    pageSize = parseInt(document.getElementById('pageSizeSelect').value, 10) || 10;
    currentPage = 1;
    if (window.groupedData) renderTable(window.groupedData);
  };

  window.gotoPage = (p) => {
    const total = lastSortedKeys.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if (p < 1 || p > totalPages) return;
    currentPage = p;
    if (window.groupedData) renderTable(window.groupedData);
  };

  function makeBtn(text, onClick, disabled) {
    const btn = document.createElement('div');
    btn.className = "page-btn" + (disabled ? " disabled" : "");
    btn.textContent = text;
    if (!disabled) btn.onclick = onClick;
    return btn;
  }

  function makePageBtn(pageNum) {
    const btn = document.createElement('div');
    btn.className = "page-btn" + (pageNum === currentPage ? " active" : "");
    btn.textContent = String(pageNum);
    btn.onclick = () => gotoPage(pageNum);
    return btn;
  }

  function renderPager(totalPages) {
    const pager = document.getElementById('pager');
    pager.innerHTML = "";
    pager.appendChild(makeBtn("<<", () => gotoPage(currentPage - 1), currentPage === 1));

    const maxShow = 5;
    const showUntil = Math.min(maxShow, totalPages);
    for (let p = 1; p <= showUntil; p++) pager.appendChild(makePageBtn(p));

    if (totalPages > maxShow + 1) {
      const ell = document.createElement('span');
      ell.className = "page-ellipsis";
      ell.textContent = "...";
      pager.appendChild(ell);
      pager.appendChild(makePageBtn(totalPages));
    } else if (totalPages === maxShow + 1) {
      pager.appendChild(makePageBtn(totalPages));
    }

    pager.appendChild(makeBtn(">>", () => gotoPage(currentPage + 1), currentPage === totalPages));
  }

  /* =========================
     ‚úÖ Delivery Table
     ========================= */

  function buildDeliveryRowsFromPackages() {
    deliveryRows = Object.values(packages)
      .map(p => ({
        pkgKey: p.key,
        pkgName: p.name || "",
        caseQty: parseInt(p.caseQty) || 1,
        sellPrice: parseFloat(p.sellPrice) || 0,
        stock: parseInt(p.stock) || 0,

        outCase: 0, outPcs: 0,
        retCase: 0, retPcs: 0,

        outKey: null,
        returnKey: null,
        appliedSellPcs: 0
      }))
      .sort((a,b) => (a.pkgName || "").localeCompare(b.pkgName || ""));
  }

  function isReturnMode() {
    // ‚úÖ show calculation mode when:
    // - reopened edit
    // - OR any return entered
    if (currentEditingGroupKey) return true;
    return deliveryRows.some(r => pcsFromCasePcs(r.retCase, r.retPcs, r.caseQty) > 0);
  }

  function renderDeliveryTable() {
    const tb = document.getElementById('deliveryPkgTbody');
    tb.innerHTML = "";

    const showSell = isReturnMode();

    deliveryRows.forEach((r, idx) => {
      const outTotal = pcsFromCasePcs(r.outCase, r.outPcs, r.caseQty);
      const retTotal = pcsFromCasePcs(r.retCase, r.retPcs, r.caseQty);

      // ‚úÖ IMPORTANT CHANGE:
      // Out ‡¶≤‡¶ø‡¶ñ‡¶≤‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§
      // ‡¶∂‡ßÅ‡¶ß‡ßÅ Return ‡¶è ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡¶≤‡ßá‡¶á (‡¶¨‡¶æ reopen ‡¶ï‡¶∞‡¶≤‡ßá) ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡•§
      const shouldComputeForRow = currentEditingGroupKey || (retTotal > 0);

      const sellPcs = (showSell && shouldComputeForRow) ? Math.max(0, outTotal - retTotal) : "";
      const amt = (showSell && shouldComputeForRow) ? (Math.max(0, outTotal - retTotal) * (parseFloat(r.sellPrice)||0)).toFixed(2) : "";

      tb.innerHTML += `
        <tr>
          <td class="pkg-cell">
            ${r.pkgName}
            <span class="pkg-sub">‡¶ï‡ßá‡¶∏‡ßá: ${r.caseQty} ‡¶™‡¶ø‡¶∏ ‚Ä¢ ‡¶∏‡ßç‡¶ü‡¶ï: ${r.stock}</span>
          </td>

          <td>
            <input class="qty-inp" type="number" min="0" value="${r.outCase}" onchange="onOutCaseChange(${idx}, this.value)">
          </td>
          <td>
            <input class="qty-inp" type="number" min="0" value="${r.outPcs}" onchange="onOutPcsChange(${idx}, this.value)">
          </td>

          <td>
            <input class="qty-inp" type="number" min="0" value="${r.retCase}" onchange="onRetCaseChange(${idx}, this.value)">
          </td>
          <td>
            <input class="qty-inp" type="number" min="0" value="${r.retPcs}" onchange="onRetPcsChange(${idx}, this.value)">
          </td>

          <td class="sellpcs-cell">${sellPcs}</td>
          <td class="money-cell">${amt === "" ? "" : "‡ß≥"+amt}</td>
        </tr>
      `;
    });

    // ‚úÖ bind faint/zero behavior (no select)
    attachZeroBehavior();
  }

  window.onOutCaseChange = (idx, v) => { deliveryRows[idx].outCase = safeNum(v); renderDeliveryTable(); };
  window.onOutPcsChange  = (idx, v) => { deliveryRows[idx].outPcs  = safeNum(v); renderDeliveryTable(); };
  window.onRetCaseChange = (idx, v) => { deliveryRows[idx].retCase = safeNum(v); renderDeliveryTable(); };
  window.onRetPcsChange  = (idx, v) => { deliveryRows[idx].retPcs  = safeNum(v); renderDeliveryTable(); };

  function getPkgKeyByName(name) {
    const k = Object.keys(packages).find(x => (packages[x]?.name || "") === name);
    return k || null;
  }

  window.startDelivery = () => {
    const s = document.getElementById('mainPersonSelect');
    if(!s.value) return alert("‡¶≤‡ßã‡¶ï ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®");
    selectedPersonName = s.value;
    currentEditingGroupKey = null;

    document.getElementById('displaySelectedPerson').innerText = "‡¶ó‡ßç‡¶∞‡¶π‡ßÄ‡¶§‡¶æ: " + selectedPersonName;
    document.getElementById('deliveryDate').value = todayISO();

    currentCashData = 0;
    currentDuesData = [];

    buildDeliveryRowsFromPackages();
    renderDeliveryTable();

    closeModal('deliverySelectModal');
    openModal('deliveryMainModal');
  };

  window.saveDeliverySmart = async () => {
    const date = document.getElementById('deliveryDate').value || todayISO();
    if(!selectedPersonName) return;

    const retMode = isReturnMode();

    if (!retMode) {
      try{
        for (const r of deliveryRows) {
          const outTotal = pcsFromCasePcs(r.outCase, r.outPcs, r.caseQty);
          if (outTotal <= 0) continue;

          const payload = {
            personName: selectedPersonName,
            date,
            type: "Out",
            pkgName: r.pkgName,
            totalPcs: outTotal,
            pkgSellPrice: r.sellPrice,
            amount: (outTotal * r.sellPrice).toFixed(2),
            cashReceived: currentCashData,
            dues: currentDuesData,
            appliedSellPcs: r.appliedSellPcs || 0
          };

          if (r.outKey) await update(ref(database, `transactions/${r.outKey}`), payload);
          else {
            const pushed = await push(ref(database, 'transactions'), payload);
            r.outKey = pushed.key;
          }
        }
        alert("‚úÖ ‡¶¨‡¶π‡¶ø‡¶∞ ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶æ‡¶ü‡ßá‡¶®‡¶ø)!");
        closeModal('deliveryMainModal');
      }catch(e){
        alert(e.message);
      }
      return;
    }

    try{
      for (const r of deliveryRows) {
        const outTotal = pcsFromCasePcs(r.outCase, r.outPcs, r.caseQty);
        const retTotal = pcsFromCasePcs(r.retCase, r.retPcs, r.caseQty);

        if (outTotal <= 0 && retTotal <= 0 && !r.outKey && !r.returnKey) continue;

        if (outTotal > 0) {
          const outPayload = {
            personName: selectedPersonName,
            date,
            type: "Out",
            pkgName: r.pkgName,
            totalPcs: outTotal,
            pkgSellPrice: r.sellPrice,
            amount: (outTotal * r.sellPrice).toFixed(2),
            cashReceived: currentCashData,
            dues: currentDuesData,
            appliedSellPcs: r.appliedSellPcs || 0
          };
          if (r.outKey) await update(ref(database, `transactions/${r.outKey}`), outPayload);
          else {
            const pushed = await push(ref(database, 'transactions'), outPayload);
            r.outKey = pushed.key;
          }
        }

        if (retTotal > 0) {
          const retPayload = {
            personName: selectedPersonName,
            date,
            type: "Return",
            pkgName: r.pkgName,
            totalPcs: retTotal,
            pkgSellPrice: r.sellPrice,
            amount: (retTotal * r.sellPrice).toFixed(2),
            cashReceived: currentCashData,
            dues: currentDuesData
          };
          if (r.returnKey) await update(ref(database, `transactions/${r.returnKey}`), retPayload);
          else {
            const pushed = await push(ref(database, 'transactions'), retPayload);
            r.returnKey = pushed.key;
          }
        } else if (r.returnKey) {
          await remove(ref(database, `transactions/${r.returnKey}`));
          r.returnKey = null;
        }

        const netSell = Math.max(0, outTotal - retTotal);

        let oldApplied = 0;
        if (r.outKey) {
          const outSnap = await get(ref(database, `transactions/${r.outKey}`));
          oldApplied = parseInt(outSnap.val()?.appliedSellPcs || 0) || 0;
        } else {
          oldApplied = parseInt(r.appliedSellPcs || 0) || 0;
        }

        const diff = netSell - oldApplied;
        if (diff !== 0) {
          const pkg = packages[r.pkgKey];
          const currentStock = parseInt(pkg?.stock) || 0;
          const newStock = currentStock - diff;
          await update(ref(database, `packages/${r.pkgKey}`), { stock: newStock });

          packages[r.pkgKey].stock = newStock;
          r.stock = newStock;
        }

        if (r.outKey) await update(ref(database, `transactions/${r.outKey}`), { appliedSellPcs: netSell });
        r.appliedSellPcs = netSell;
      }

      alert("‚úÖ ‡¶´‡ßá‡¶∞‡¶§ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá + ‡¶∏‡ßá‡¶≤ ‡¶™‡¶ø‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
      closeModal('deliveryMainModal');
    }catch(e){
      alert(e.message);
    }
  };

  window.reopenDeliveryForm = (dateKey) => {
    const group = window.groupedData[dateKey];
    selectedPersonName = group.name;
    currentEditingGroupKey = dateKey;

    document.getElementById('displaySelectedPerson').innerText = "‡¶ó‡ßç‡¶∞‡¶π‡ßÄ‡¶§‡¶æ: " + group.name;
    document.getElementById('deliveryDate').value = group.date;

    currentCashData = group.cash || 0;
    currentDuesData = group.items[0]?.dues || [];

    buildDeliveryRowsFromPackages();

    group.items.forEach(item => {
      const pKey = getPkgKeyByName(item.pkgName);
      if (!pKey) return;
      const row = deliveryRows.find(x => x.pkgKey === pKey);
      if (!row) return;

      const tq = parseInt(item.totalPcs) || 0;
      if ((item.type || "Out") === "Out") {
        const sp = splitToCasePcs(tq, row.caseQty);
        row.outCase = sp.c; row.outPcs = sp.p;
        row.outKey = item.key;
        row.appliedSellPcs = parseInt(item.appliedSellPcs || 0) || 0;
      } else {
        const sp = splitToCasePcs(tq, row.caseQty);
        row.retCase = sp.c; row.retPcs = sp.p;
        row.returnKey = item.key;
      }
    });

    renderDeliveryTable();
    openModal('deliveryMainModal');
  };

  window.deleteTransactionGroup = async (dateKey) => {
    if(!confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
    const items = window.groupedData[dateKey].items;
    for(let itm of items) {
      const pKey = getPkgKeyByName(itm.pkgName);
      if(pKey) {
        const pkg = packages[pKey];
        let adj = itm.type === "Out" ? parseInt(itm.totalPcs) : -parseInt(itm.totalPcs);
        await update(ref(database, `packages/${pKey}`), { stock: (parseInt(pkg.stock) || 0) + adj });
      }
      await remove(ref(database, `transactions/${itm.key}`));
    }
    alert("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
  };

  window.openPaymentForm = (dateKey) => {
    activePaymentGroupKey = dateKey;
    const group = window.groupedData[dateKey];
    document.getElementById('paymentTitle').innerText = group.name + " - ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®";
    document.getElementById('cashReceivedInput').value = String(group.cash || 0);
    currentDues = group.items[0]?.dues || [];
    editingDueIndex = null;
    renderDuesList();
    openModal('paymentModal');
    attachZeroBehavior();
  };

  window.addDueToList = () => {
    const shop = document.getElementById('dueShopName').value.trim();
    const amt = parseFloat(document.getElementById('dueAmount').value) || 0;
    if(!shop || amt <= 0) return;

    if (editingDueIndex !== null && currentDues[editingDueIndex]) {
      currentDues[editingDueIndex] = { shop, amt };
      editingDueIndex = null;
    } else {
      currentDues.push({ shop, amt });
    }

    document.getElementById('dueShopName').value = "";
    document.getElementById('dueAmount').value = "0";
    renderDuesList();
    attachZeroBehavior();
  };

  window.editDueItem = (idx) => {
    if (!currentDues[idx]) return;
    editingDueIndex = idx;
    document.getElementById('dueShopName').value = currentDues[idx].shop || "";
    document.getElementById('dueAmount').value = String(currentDues[idx].amt || 0);
    attachZeroBehavior();
  };

  function renderDuesList() {
    const cont = document.getElementById('dueListContainer');
    cont.innerHTML = "";
    currentDues.forEach((d, i) => {
      cont.innerHTML += `
        <div class="due-item" onclick="editDueItem(${i})">
          <span>${d.shop}</span>
          <span>‡ß≥${d.amt}</span>
        </div>
      `;
    });
  }

  window.savePaymentData = async () => {
    const cash = parseFloat(document.getElementById('cashReceivedInput').value) || 0;
    const items = window.groupedData[activePaymentGroupKey].items;
    for(let item of items) {
      await update(ref(database, `transactions/${item.key}`), { cashReceived: cash, dues: currentDues });
    }
    alert("‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    closeModal('paymentModal');
  };

  window.savePerson = () => {
    const name = document.getElementById('personName').value.trim();
    if(name) push(ref(database, 'persons'), { name }).then(() => {
      document.getElementById('personName').value = "";
      closeModal('personModal');
    });
  };

  // initial bind
  setTimeout(attachZeroBehavior, 500);
</script>
</body>
</html>
